<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>ì•ˆë‹¤ì¹˜ì¡° â€“ Wearable Real-time Dashboard</title>

  <!-- MQTT JS (Browser) -->
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

  <style>
    /* ============= Global ============= */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Pretendard", "Noto Sans KR",
        system-ui, sans-serif;
      background: radial-gradient(circle at 20% 10%, #E7F4EF, #F8FAF9 60%);
      color: #1f2a2c;
      padding: 24px;
    }

    .page {
      max-width: 1100px;
      margin: 0 auto;
    }

    /* ============= Header ============= */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 20px;
    }

    .brand-left {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .brand-top {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 4px;
    }

    .logo-wrap {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .andachi-logo {
      width: 48px;
      height: 48px;
      flex-shrink: 0;
      display: block;
    }

    .team-badge {
      display: inline-flex;
      align-items: center;
      padding: 4px 12px;
      border-radius: 999px;
      background: rgba(15, 76, 58, 0.10);
      border: 1px solid rgba(15, 76, 58, 0.24);
      color: #0F4C3A;
      font-size: 13px;
      font-weight: 600;
      letter-spacing: 0.3px;
    }

    .title {
      font-size: 30px;
      font-weight: 800;
      color: #0F4C3A;
    }

    .subtitle {
      font-size: 13px;
      color: #5F6A67;
      margin-top: 2px;
    }

    .header-right {
      font-size: 12px;
      color: #7d8a85;
      display: flex;
      align-items: center;
    }

    .last-update-label {
      margin-right: 4px;
      font-weight: 500;
    }

    /* ============= Layout ============= */
    .main-grid {
      display: grid;
      grid-template-columns: 2.1fr 1.2fr;
      gap: 16px;
    }

    @media (max-width: 900px) {
      .main-grid {
        grid-template-columns: 1fr;
      }
    }

    /* ============= Cards ============= */
    .card {
      background: #ffffff;
      border-radius: 18px;
      padding: 18px 20px;
      box-shadow: 0 10px 25px rgba(15, 76, 58, 0.07);
    }

    .card-header {
      margin-bottom: 10px;
    }

    .card-title {
      font-size: 18px;
      font-weight: 700;
      color: #1f2a2c;
    }

    .card-sub {
      font-size: 13px;
      color: #6b7a78;
      margin-top: 6px;
      margin-bottom: 10px;
      line-height: 1.4;
    }

    /* ============= Pills ============= */
    .pill {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 4px 12px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
    }

    .pill-low {
      background: #E4F6EC;
      color: #0F6A3A;
    }

    .pill-med {
      background: #FFF3D6;
      color: #A76B11;
    }

    .pill-high {
      background: #FFE1E1;
      color: #B3261E;
    }

    .emg-pill {
      font-size: 11px;
      padding: 2px 8px;
      margin-left: 6px;
    }

    /* ============= Metric rows ============= */
    .metric-row {
      margin-top: 16px;
    }

    .metric-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }

    .metric-label {
      font-size: 14px;
      font-weight: 600;
    }

    .metric-unit {
      font-size: 12px;
      color: #8a9896;
      margin-left: 4px;
    }

    .metric-value {
      font-size: 13px;
      color: #4d5b59;
    }

    .scale-bar {
      position: relative;
      height: 10px;
      border-radius: 999px;
      overflow: hidden;
      background: linear-gradient(
        to right,
        #C3E8D2 0%,
        #C3E8D2 33%,
        #FFE5AA 33%,
        #FFE5AA 66%,
        #FFC1C1 66%,
        #FFC1C1 100%
      );
      margin-bottom: 4px;
    }

    .scale-marker {
      position: absolute;
      top: -4px;
      width: 0;
      height: 18px;
      border-left: 3px solid #222;
    }

    .scale-caption {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      color: #8a9896;
    }

    .scale-caption .dot {
      margin-right: 4px;
      font-size: 10px;
    }

    .safe { color: #0F6A3A; }
    .warn { color: #A76B11; }
    .danger { color: #B3261E; }

    /* ============= EMG Summary ============= */
    .emg-summary-row {
      margin-top: 22px;
      padding: 12px 14px;
      border-radius: 14px;
      background: #F7FBFA;
      border: 1px dashed #C7D9D4;
    }

    .emg-summary-title {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 6px;
      color: #26413C;
    }

    .hint-muted {
      font-size: 11px;
      color: #9AA7A4;
      margin-top: 4px;
      white-space: pre-line;
    }

    .lock-btn {
      margin-top: 10px;
      padding: 6px 12px;
      font-size: 12px;
      border-radius: 999px;
      border: 1px solid #C7D9D4;
      background: #F7FBFA;
      cursor: pointer;
    }

    .lock-btn:disabled {
      opacity: 0.6;
      cursor: default;
    }

    /* ============= Right Panel ============= */
    .guide-title {
      font-size: 17px;
      font-weight: 700;
      margin-bottom: 6px;
    }

    .guide-text {
      font-size: 13px;
      color: #5F6A67;
      line-height: 1.5;
      margin-bottom: 14px;
      white-space: pre-line;
    }

    .divider {
      height: 1px;
      background: #EEF3F2;
      margin: 10px 0 12px;
    }

    .coach-status-pill {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 999px;
      background: #E7F4EF;
      color: #0F4C3A;
      font-size: 12px;
      margin-bottom: 6px;
    }

    .coach-status-pill-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      margin-right: 6px;
      background: #18A05D;
    }

    .coach-title {
      font-size: 15px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .coach-body {
      font-size: 13px;
      color: #5F6A67;
      line-height: 1.5;
      margin-bottom: 10px;
      white-space: pre-line;
    }

    .coach-tips {
      font-size: 11px;
      color: #9aa7a4;
      white-space: pre-line;
    }
  </style>
</head>

<body>
  <div class="page">

    <!-- ============ Header ============ -->
    <header class="header">
      <div class="brand-left">
        <div class="brand-top">
          <div class="logo-wrap">
            <svg class="andachi-logo" viewBox="0 0 64 64">
              <circle cx="32" cy="32" r="30" fill="#0F4C3A" />
              <path d="M32 14 L21 18 v12 c0 8.5 5 14.5 11 17.5 c6-3 11-9 11-17.5 V18 Z"
                fill="#F8FAF9" />
              <circle cx="33" cy="29.5" r="2.4" fill="#0F4C3A" />
            </svg>
          </div>
          <div class="team-badge"><span>ì•ˆë‹¤ì¹˜ì¡° ANDACHI</span></div>
        </div>

        <div class="title">Wearable Real-time Dashboard</div>
        <div class="subtitle">IMU + EMG ê¸°ë°˜ ì‹¤ì‹œê°„ ë¬´ë¦ ë¶€ìƒ ìœ„í—˜ ëª¨ë‹ˆí„°ë§</div>
      </div>

      <div class="header-right">
        <span class="last-update-label">Last update:</span>
        <span id="lastUpdated">-</span>
      </div>
    </header>


    <!-- ============ MAIN GRID ============ -->
    <div class="main-grid">

      <!-- LEFT SECTION -->
      <div>
        <div class="card">

          <!-- ===== TITLE ===== -->
          <div class="card-header">
            <div class="card-title" style="display:flex; flex-direction:column; line-height:1.2;">
              ì‹¤ì‹œê°„ ë¬´ë¦ ë¶€ìƒ ìœ„í—˜ë„
              <span style="font-size:10px; color:#6b7a78; font-weight:400; margin-top:3px;">
                (ë¬´ë¦ ìƒëŒ€ ê°ì†ë„ í”¼í¬ê°’ ê¸°ë°˜)
              </span>
            </div>
          </div>

          <!-- ===== ANGLE RATE METRIC ===== -->
          <div class="metric-row">
            <div class="metric-top">
              <div>
                <span class="metric-label">ë¬´ë¦ ìƒëŒ€ ê°ì†ë„ í”¼í¬</span>
                <span class="metric-unit">(deg/s)</span>
              </div>

              <div class="metric-value">
                <span id="angleRateVal">-</span>
                <span> Â· </span>
                <span id="angleRateLevel"
                      class="pill pill-low"
                      style="font-size:14px; padding:4px 12px;">
                  LOW
                </span>
              </div>
            </div>

            <div class="scale-bar">
              <div id="angleRateMarker" class="scale-marker"></div>
            </div>

            <div class="scale-caption">
              <span class="safe"><span class="dot">â—</span>ì•ˆì • (&lt;100)</span>
              <span class="warn"><span class="dot">â—</span>ì£¼ì˜ (100â€“200)</span>
              <span class="danger"><span class="dot">â—</span>ìœ„í—˜ (&gt;=200)</span>
            </div>
          </div>

          <div id="overallDesc" class="card-sub">
            ì°©ì§€Â·ë°©í–¥ì „í™˜ ìˆœê°„ì— ë¬´ë¦ì´ ì–¼ë§ˆë‚˜ ë¹ ë¥´ê²Œ êº¾ì˜€ë‹¤ í´ì§€ëŠ”ì§€ë¥¼ ë³´ì—¬ì£¼ëŠ” ê°’ì…ë‹ˆë‹¤.
            ì°©ì§€ ì¶©ê²©ì´ë‚˜ ë°©í–¥ ì „í™˜ ë¶€í•˜ê°€ í´ìˆ˜ë¡ ì´ ê°’ì´ ë†’ê²Œ ë‚˜íƒ€ë‚  ìˆ˜ ìˆì–´ìš”.
          </div>

          <!-- ===== EMG REPORT BOX ===== -->
          <div class="metric-row emg-summary-row">
            <div class="emg-summary-title">EMG ì„¸ì…˜ í”¼ë¡œ ë¶„ì„ ë¦¬í¬íŠ¸</div>
            <div class="emg-summary-text" style="font-size:11px;">
              RMS ì¦ê°€ìœ¨: <span id="emgRmsReport">-</span>%
              <span id="emgRmsLevel" class="pill emg-pill pill-low" style="display:none;">LOW</span><br/>
              MDF ê°ì†Œìœ¨: <span id="emgMdfReport">-</span>%
              <span id="emgMdfLevel" class="pill emg-pill pill-low" style="display:none;">LOW</span>
            </div>

            <div class="hint-muted">
              ì‹¤ì‹œê°„ ë°ì´í„°ëŠ” ê³„ì† ë³€í™”í•©ë‹ˆë‹¤.
              ìš´ë™ì„ ë§ˆì¹œ ë’¤ ë²„íŠ¼ì„ ëˆŒëŸ¬ í•´ë‹¹ ì‹œì ì˜ ê°’ì„ ì„¸ì…˜ ë¦¬í¬íŠ¸ë¡œ ì €ì¥í•˜ì„¸ìš”.
            </div>

            <button id="lockEmgReportBtn" type="button" class="lock-btn">
              ìš´ë™ ì¢…ë£Œ Â· ë¦¬í¬íŠ¸ ê³ ì •í•˜ê¸°
            </button>

            <div id="lockStatusText" class="hint-muted" style="margin-top:6px;">
              ì•„ì§ ì„¸ì…˜ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤. ìš´ë™ì„ ë§ˆì¹˜ë©´ ìœ„ ë²„íŠ¼ì„ ëˆŒëŸ¬ ë¦¬í¬íŠ¸ë¥¼ ê³ ì •í•˜ì„¸ìš”.
            </div>
          </div>
        </div>
      </div>


      <!-- RIGHT SECTION -->
      <div>
        <div class="card">
          <div class="guide-title">ë¶€ìƒ ì˜ˆë°© ê°€ì´ë“œ</div>
          <div id="guideText" class="guide-text">
            ì„¼ì„œê°€ ì•ˆì •ì ìœ¼ë¡œ ìˆ˜ì§‘ë˜ë©´ ì´ ì˜ì—­ì— í˜„ì¬ ìœ„í—˜ ìš”ì¸ê³¼
            ì˜ˆë°© í–‰ë™ì´ í‘œì‹œë©ë‹ˆë‹¤.
          </div>

          <div class="divider"></div>

          <div class="guide-title" style="font-size:16px;">AI ìì„¸ êµì • ì½”ë©˜íŠ¸</div>
          <div id="coachStatusPill" class="coach-status-pill">
            <span class="coach-status-pill-dot"></span>
            <span id="coachStatusText">ì•ˆì „ ìì„¸</span>
          </div>

          <div id="coachTitle" class="coach-title">ì¢‹ì€ ìì„¸ë¥¼ ìœ ì§€í•˜ê³  ìˆì–´ìš”</div>
          <div id="coachBody" class="coach-body">
            ì›€ì§ì„ì„ ì‹œì‘í•˜ë©´ ì„¼ì„œ ê¸°ë°˜ìœ¼ë¡œ ìì„¸ í”¼ë“œë°±ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.
          </div>

          <div id="coachTips" class="coach-tips">
            ê¸°ì¤€ê°’ ê°ì†ë„: &lt;100 low Â· 100â€“200 med Â· â‰¥200 high  
            EMG í”¼ë¡œë„ëŠ” RMS ì¦ê°€ìœ¨Â·MDF ê°ì†Œìœ¨ë¡œ ìš”ì•½ë˜ì–´ ì™¼ìª½ ë¦¬í¬íŠ¸ì— í‘œì‹œë©ë‹ˆë‹¤.
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- ================= Scripts ================= -->
  <script>
    const BROKER_URL = "wss://damoa.io:9002";
    const RISK_TOPIC = "ewha/2270056/risk";
    const clientId = "andachi-web-" + Math.random().toString(16).substring(2, 10);
    const client = mqtt.connect(BROKER_URL, { clientId });

    let emgReportLocked = false;
    let emgReportSnapshot = null;

    client.on("connect", () => {
      client.subscribe(RISK_TOPIC);
    });

    client.on("message", (topic, message) => {
      if (topic === RISK_TOPIC) {
        try {
          updateDashboard(JSON.parse(message.toString()));
        } catch (e) {
          console.error("JSON parse error:", e);
        }
      }
    });

    function fmtNumber(v, digits = 1) {
      return (v == null || !isFinite(v)) ? "-" : v.toFixed(digits);
    }

    function levelToClass(lv) {
      if (lv === "high") return "pill-high";
      if (lv === "med") return "pill-med";
      return "pill-low";
    }

    function clampPercent(v) {
      return Math.max(0, Math.min(100, v));
    }

    function renderEmgReport(rms, mdf, rmsLv, mdfLv) {
      document.getElementById("emgRmsReport").textContent = fmtNumber(rms);
      document.getElementById("emgMdfReport").textContent = fmtNumber(mdf);

      const rPill = document.getElementById("emgRmsLevel");
      const mPill = document.getElementById("emgMdfLevel");

      if (!isFinite(rms)) rPill.style.display = "none";
      else {
        rPill.style.display = "inline-flex";
        rPill.className = "pill emg-pill " + levelToClass(rmsLv);
        rPill.textContent = rmsLv.toUpperCase();
      }

      if (!isFinite(mdf)) mPill.style.display = "none";
      else {
        mPill.style.display = "inline-flex";
        mPill.className = "pill emg-pill " + levelToClass(mdfLv);
        mPill.textContent = mdfLv.toUpperCase();
      }
    }

    function getCoaching(overall, angleLv, rmsLv, mdfLv) {
      let status, title, body, guide;

      if (overall === "low") {
        status = "ğŸŸ¢ LOW ìœ„í—˜ë„";
        title = "í˜„ì¬ ìƒíƒœ ì–‘í˜¸í•©ë‹ˆë‹¤.";
        body = "ê°€ë³ê²Œ ë‹¬ë¦¬ê¸°ë¥¼ ì§„í–‰í•´ë„ ì¢‹ì€ ìƒíƒœì…ë‹ˆë‹¤.\në¬´ë¦ ì£¼ë³€ ì§€ì§€ ê·¼ìœ¡ì„ ê¾¸ì¤€íˆ ê°•í™”í•´ ì£¼ì„¸ìš”.";
        guide = "â€¢ ë™ì  ì›Œë°ì—… 5â€“10ë¶„\nâ€¢ ëŸ¬ë‹ í›„ ìŠ¤íŠ¸ë ˆì¹­ 20â€“30ì´ˆ\nâ€¢ ì£¼ê°„ í›ˆë ¨ëŸ‰ +10% ì´ìƒ ì¦ê°€ ê¸ˆì§€";
      }
      else if (overall === "med") {
        status = "ğŸŸ¡ MED ìœ„í—˜ë„";
        title = "ë¶€í•˜ë‚˜ í”¼ë¡œ ì¦ê°€ ì‹ í˜¸ì…ë‹ˆë‹¤.";
        body = "ì¶©ê²© ë˜ëŠ” ê·¼ ì‚¬ìš©ëŸ‰ì´ ì¦ê°€í•˜ê³  ìˆìŠµë‹ˆë‹¤.\nê±°ë¦¬ë¥¼ ì¤„ì´ê±°ë‚˜ í˜ì´ìŠ¤ë¥¼ ë‚®ì¶”ë©´ ì¢‹ìŠµë‹ˆë‹¤.";
        guide = "â€¢ í‰ì†Œ 70â€“80% ê°•ë„ë¡œ ì¡°ì ˆ\nâ€¢ í™Â·ì¢…ì•„ë¦¬ ê°•í™”ìš´ë™ 1â€“2ì„¸íŠ¸";
      }
      else {
        status = "ğŸ”´ HIGH ìœ„í—˜ë„";
        title = "ì§€ê¸ˆì€ ë¶€ìƒ ìœ„í—˜ì´ ë†’ì€ ìƒíƒœì…ë‹ˆë‹¤.";
        body = "ì¶©ê²©ëŸ‰ í˜¹ì€ í”¼ë¡œë„ê°€ ë§ì´ ì¦ê°€í–ˆìŠµë‹ˆë‹¤.\nëŸ¬ë‹ ê°•ë„ë¥¼ ì¦‰ì‹œ ë‚®ì¶”ê±°ë‚˜ ì¤‘ë‹¨í•˜ì„¸ìš”.";
        guide = "â€¢ ì €ì¶©ê²© ìš´ë™ìœ¼ë¡œ ëŒ€ì²´\nâ€¢ ì°©ì§€ íŒ¨í„´Â·ì¼€ì´ë˜ìŠ¤ ì ê²€";
      }

      return { status, title, body, guide };
    }

    function updateDashboard(payload) {
      const ts = payload.ts || Date.now();
      const d = new Date(ts);
      document.getElementById("lastUpdated").textContent =
        `${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}:${String(d.getSeconds()).padStart(2,"0")}`;

      const angle = payload.angleRate_peak_deg_s;
      const rms = payload.emg_rms_drop_pct;
      const mdf = payload.mdf_drop_pct;

      const risk = payload.risk || {};
      const angleLv = risk.angleRate || "low";
      const rmsLv = risk.rmsDrop || "low";
      const mdfLv = risk.mdfDrop || "low";
      const overall = risk.overall || "low";

      document.getElementById("angleRateVal").textContent = fmtNumber(angle);
      const pill = document.getElementById("angleRateLevel");
      pill.className = "pill " + levelToClass(angleLv);
      pill.textContent = angleLv.toUpperCase();

      const percent = clampPercent(angle / 250 * 100);
      document.getElementById("angleRateMarker").style.left = percent + "%";

      if (emgReportLocked && emgReportSnapshot) {
        renderEmgReport(
          emgReportSnapshot.rmsDrop,
          emgReportSnapshot.mdfDrop,
          emgReportSnapshot.rmsLevel,
          emgReportSnapshot.mdfLevel
        );
      } else {
        renderEmgReport(rms, mdf, rmsLv, mdfLv);
        emgReportSnapshot = { rmsDrop: rms, mdfDrop: mdf, rmsLevel: rmsLv, mdfLevel: mdfLv };
      }

      const coach = getCoaching(overall, angleLv, rmsLv, mdfLv);
      document.getElementById("guideText").textContent = coach.guide;
      document.getElementById("coachStatusText").textContent = coach.status;
      document.getElementById("coachTitle").textContent = coach.title;
      document.getElementById("coachBody").textContent = coach.body;

      const pillBg = overall === "high" ? "#FFE1E1" : overall === "med" ? "#FFF3D6" : "#E7F4EF";
      const dotColor = overall === "high" ? "#E53935" : overall === "med" ? "#FFC107" : "#18A05D";

      const coachPill = document.getElementById("coachStatusPill");
      coachPill.style.background = pillBg;
      coachPill.querySelector(".coach-status-pill-dot").style.background = dotColor;
    }

    document.getElementById("lockEmgReportBtn").addEventListener("click", () => {
      const status = document.getElementById("lockStatusText");

      if (!emgReportSnapshot) {
        status.textContent = "ì•„ì§ EMG ë°ì´í„°ê°€ ì¶©ë¶„í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.\nì¡°ê¸ˆ ë” ì›€ì§ì¸ ë’¤ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.";
        return;
      }

      emgReportLocked = true;
      document.getElementById("lockEmgReportBtn").disabled = true;

      const { rmsDrop, mdfDrop } = emgReportSnapshot;

      status.textContent =
        `ì„¸ì…˜ ë¦¬í¬íŠ¸ê°€ ê³ ì •ë˜ì—ˆìŠµë‹ˆë‹¤.\n\n` +
        `RMS ì¦ê°€ìœ¨: ${fmtNumber(rmsDrop)}%\n` +
        `MDF ê°ì†Œìœ¨: ${fmtNumber(mdfDrop)}%`;
    });
  </script>
</body>
</html>
