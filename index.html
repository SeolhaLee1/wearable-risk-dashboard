<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<title>Wearable Risk Dashboard</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

<style>
body { font-family: Arial; background:#fafafa; padding:20px; }
.card { padding:15px; border-radius:10px; margin:10px 0; }
#riskBox { font-size:32px; font-weight:bold; color:white; padding:20px; border-radius:15px; }
</style>

</head>
<body>

<h2>ğŸƒ Wearable Real-time Dashboard</h2>

<div id="riskBox">Risk: -</div>

<canvas id="imuChart" height="100"></canvas>
<canvas id="emgChart" height="100"></canvas>

<script>
const brokerUrl = "wss://damoa.io:9002";
const clientId = "webdash-" + Math.random().toString(16).substr(2, 8);

const client = mqtt.connect(brokerUrl, { clientId });

// 1) ì°¨íŠ¸ ê¸°ë³¸ ì„¸íŒ… ===========================
const imuCtx = document.getElementById("imuChart").getContext("2d");
const emgCtx = document.getElementById("emgChart").getContext("2d");

const imuChart = new Chart(imuCtx, {
  type: "line",
  data: {
    labels: [],
    datasets: [
      { label:"IMU2 Gyro Magnitude", data:[], borderColor:"blue" }
    ]
  }
});

const emgChart = new Chart(emgCtx, {
  type: "line",
  data: {
    labels: [],
    datasets: [
      { label:"EMG Envelope", data:[], borderColor:"red" }
    ]
  }
});

// 2) MQTT ì—°ê²° ===============================
client.on("connect", () => {
  console.log("MQTT Connected!");
  client.subscribe("ewha/2270056/raw");
  client.subscribe("ewha/2270056/risk");
});

// 3) ë©”ì‹œì§€ ìˆ˜ì‹  ==============================
client.on("message", (topic, payload) => {
  let msg;
  try { msg = JSON.parse(payload.toString()); } catch { return; }

  // ---- raw ì„¼ì„œê°’ ë°˜ì˜ ----
  if (topic.includes("raw")) {
    const t = msg.ts;
    const g2x = parseFloat(msg.imu2?.gx);
    const g2y = parseFloat(msg.imu2?.gy);
    const g2z = parseFloat(msg.imu2?.gz);
    const emg = parseFloat(msg.emg?.env);

    const gmag = Math.sqrt(g2x*g2x + g2y*g2y + g2z*g2z);

    imuChart.data.labels.push(t);
    imuChart.data.datasets[0].data.push(gmag);
    if (imuChart.data.labels.length > 100) {
      imuChart.data.labels.shift();
      imuChart.data.datasets[0].data.shift();
    }
    imuChart.update();

    emgChart.data.labels.push(t);
    emgChart.data.datasets[0].data.push(emg);
    if (emgChart.data.labels.length > 100) {
      emgChart.data.labels.shift();
      emgChart.data.datasets[0].data.shift();
    }
    emgChart.update();
  }

  // ---- risk ì»¬ëŸ¬ ë°•ìŠ¤ ì—…ë°ì´íŠ¸ ----
  if (topic.includes("risk")) {
    const risk = msg?.risk?.overall || "-";
    const box = document.getElementById("riskBox");
    box.innerHTML = "Risk: " + risk;

    if (risk == "high") box.style.background = "#e60000";
    else if (risk == "med") box.style.background = "#e6b800";
    else if (risk == "low") box.style.background = "#00b300";
    else box.style.background = "#777";
  }
});
</script>

</body>
</html>
