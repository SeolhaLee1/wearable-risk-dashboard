<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>ì•ˆë‹¤ì¹˜ì¡° ì‹¤ì‹œê°„ ë¶€ìƒì˜ˆë°© ëŒ€ì‹œë³´ë“œ</title>

<!-- MQTT -->
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- ìŠ¤íƒ€ì¼ (Ewha Green í…Œë§ˆ + ì¹´ë“œ + ë ˆì´ì•„ì›ƒ) -->
<style>
    body {
        margin: 0;
        font-family: Pretendard, 'Noto Sans KR', sans-serif;
        background: #f5f7f5;
        color: #123423;
    }

    header {
        background: #0B3D2E;
        color: white;
        padding: 18px 30px;
        font-size: 26px;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .logo {
        font-size: 32px;
        font-weight: 900;
        padding: 3px 10px;
        background: white;
        color: #0B3D2E;
        border-radius: 6px;
    }

    .container {
        padding: 25px;
        display: grid;
        grid-template-columns: 1.1fr 1fr;
        grid-gap: 25px;
    }

    .card {
        background: white;
        border-radius: 14px;
        padding: 20px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        margin-bottom: 20px;
    }

    .card-title {
        font-weight: 700;
        margin-bottom: 10px;
        font-size: 20px;
        color: #0B3D2E;
    }

    /* Risk Pill */
    .pill {
        padding: 4px 14px;
        border-radius: 20px;
        color: white;
        display: inline-block;
        margin-left: 8px;
        font-weight: 600;
    }
    .low { background: #2ecc71; }
    .med { background: #f1c40f; color: black; }
    .high { background: #e74c3c; }

    /* ì „ì²´ ìœ„í—˜ë„ Progress Bar */
    .progress-wrapper {
        height: 20px;
        background: #e8f0ea;
        border-radius: 10px;
        overflow: hidden;
        margin-top: 10px;
    }
    .progress-bar {
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, #2ecc71, #f1c40f, #e74c3c);
        transition: width 0.6s ease;
    }

    /* Stick Figure Canvas */
    #stickCanvas {
        width: 100%;
        height: 260px;
        background: #f9fbf9;
        border-radius: 10px;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 8px;
    }
    th, td {
        padding: 6px 3px;
        border-bottom: 1px solid #eee;
        font-size: 14px;
    }
    th {
        background: #eaf1ed;
    }

    .ai-box {
        background: #eaf5ef;
        padding: 15px;
        border-radius: 10px;
        font-size: 15px;
        margin-top: 10px;
        border-left: 4px solid #0B3D2E;
        line-height: 1.5;
    }
</style>
</head>
<body>

<header>
    <div class="logo">ì•ˆë‹¤ì¹˜ì¡°</div>
    ì‹¤ì‹œê°„ ë¶€ìƒì˜ˆë°© ëŒ€ì‹œë³´ë“œ
</header>

<div class="container">

    <!-- ì™¼ìª½: ì‹¤ì‹œê°„ ì‹œê°í™” -->
    <div>

        <!-- ìŠ¤í‹± í”¼ê²¨ -->
        <div class="card">
            <div class="card-title">ì‹¤ì‹œê°„ ìì„¸(Stick Figure)</div>
            <canvas id="stickCanvas"></canvas>
        </div>

        <!-- ì „ì²´ ìœ„í—˜ë„ -->
        <div class="card">
            <div class="card-title">
                ì „ì²´ ìœ„í—˜ë„ 
                <span id="overall-pill" class="pill low">low</span>
            </div>
            <div class="progress-wrapper">
                <div id="risk-progress" class="progress-bar"></div>
            </div>
        </div>

        <!-- ì‹¤ì‹œê°„ ê·¸ë˜í”„ -->
        <div class="card">
            <div class="card-title">ê°ì†ë„ ë³€í™” (AngleRate)</div>
            <canvas id="angleChart"></canvas>
        </div>

        <div class="card">
            <div class="card-title">EMG RMS</div>
            <canvas id="rmsChart"></canvas>
        </div>

        <div class="card">
            <div class="card-title">EMG MDF</div>
            <canvas id="mdfChart"></canvas>
        </div>

    </div>

    <!-- ì˜¤ë¥¸ìª½: ì‹¤ì‹œê°„ ë°ì´í„° / ìœ„í—˜ë„ / AI ì½”ë©˜íŠ¸ -->
    <div>

        <!-- ì„¸ë¶€ ìœ„í—˜ë„ -->
        <div class="card">
            <div class="card-title">ì„¸ë¶€ ìœ„í—˜ ë¶„ì„</div>
            <table>
                <tr><th>ì§€í‘œ</th><th>ê°’</th><th>ìœ„í—˜ë„</th></tr>
                <tr><td>ê°ì†ë„ peak</td><td id="val-angle">-</td><td id="risk-angle">-</td></tr>
                <tr><td>RMS drop</td><td id="val-rms">-</td><td id="risk-rms">-</td></tr>
                <tr><td>MDF drop</td><td id="val-mdf">-</td><td id="risk-mdf">-</td></tr>
                <tr><td>IMU2(Local)</td><td id="val-local">-</td><td id="risk-local">-</td></tr>
            </table>
        </div>

        <!-- ìµœì‹  ê°’ í‘œ -->
        <div class="card">
            <div class="card-title">ì‹¤ì‹œê°„ Raw Data</div>
            <table>
                <tr><th>í•­ëª©</th><th>ê°’</th></tr>
                <tr><td>i1_gx</td><td id="raw-gx1">-</td></tr>
                <tr><td>i1_gy</td><td id="raw-gy1">-</td></tr>
                <tr><td>i1_gz</td><td id="raw-gz1">-</td></tr>
                <tr><td>i2_gx</td><td id="raw-gx2">-</td></tr>
                <tr><td>i2_gy</td><td id="raw-gy2">-</td></tr>
                <tr><td>i2_gz</td><td id="raw-gz2">-</td></tr>
                <tr><td>EMG env</td><td id="raw-emg">-</td></tr>
            </table>
        </div>

        <!-- AI ì½”ë©˜íŠ¸ -->
        <div class="card">
            <div class="card-title">AI ìì„¸ / ë¶€ìƒ ì˜ˆë°© ì½”ë©˜íŠ¸</div>
            <div id="ai-comment" class="ai-box">
                ì‹¤ì‹œê°„ ë°ì´í„° ìˆ˜ì§‘ ì¤‘... (ì„¼ì„œë¥¼ ì—°ê²°í•˜ì„¸ìš”!)
            </div>
        </div>

    </div>
</div>

<script>
// ======================= MQTT ì—°ê²° =======================
const client = mqtt.connect("wss://damoa.io:9002");

client.on("connect", () => {
    console.log("MQTT Connected!");
    client.subscribe("ewha/2270056/risk");
});

// ======================= ê·¸ë˜í”„ ì¤€ë¹„ =======================
function createChart(ctx) {
    return new Chart(ctx, {
        type: "line",
        data: { labels: [], datasets: [{
            data: [],
            borderColor: "#0B3D2E",
            borderWidth: 2,
            tension: 0.2
        }]},
        options: {
            animation: false,
            scales: { x: { display: false }, y: { beginAtZero: true } }
        }
    });
}

const angleChart = createChart(document.getElementById("angleChart"));
const rmsChart   = createChart(document.getElementById("rmsChart"));
const mdfChart   = createChart(document.getElementById("mdfChart"));

// ======================= ìŠ¤í‹± í”¼ê²¨ =======================
const canvas = document.getElementById("stickCanvas");
const ctx = canvas.getContext("2d");

function drawStick(angle) {
    ctx.clearRect(0,0,canvas.width,canvas.height);

    const cx = canvas.width/2;
    const cy = 60;

    const L1 = 80, L2 = 80;

    const rad = angle * Math.PI/180;

    const hx = cx + L1 * Math.sin(rad);
    const hy = cy + L1 * Math.cos(rad);

    const fx = hx + L2 * Math.sin(rad);
    const fy = hy + L2 * Math.cos(rad);

    ctx.lineWidth = 6;
    ctx.strokeStyle = "#0B3D2E";

    ctx.beginPath();
    ctx.moveTo(cx, cy);
    ctx.lineTo(hx, hy);
    ctx.lineTo(fx, fy);
    ctx.stroke();
}

// ======================= ìœ„í—˜ë„ â†’ ìƒ‰/ì •ì±… =======================
function pillHtml(level) {
    const cls = level === "high" ? "high" :
                level === "med" ? "med" : "low";
    return `<span class="pill ${cls}">${level}</span>`;
}

function updateOverall(level) {
    const bar = document.getElementById("risk-progress");
    const pill = document.getElementById("overall-pill");

    pill.className = `pill ${level}`;
    pill.innerText = level;

    bar.style.width = level === "high" ? "100%" :
                      level === "med"  ? "60%" : "25%";
}

// ======================= AI ì½”ë©˜íŠ¸ ìƒì„± =======================
function makeComment(risk, angle, rms, mdf) {
    if (risk === "high") {
        return "âš  ë¬´ë¦ì— ìˆœê°„ì ì¸ í° ë¶€í•˜ê°€ ê°ì§€ë˜ì—ˆì–´ìš”! ë¬´ë¦ì„ ë” êµ¬ë¶€ë¦¬ê±°ë‚˜, ì°©ì§€ ì¶©ê²©ì„ ì™„í™”í•˜ëŠ” ìì„¸ë¥¼ ì‹œë„í•´ë³´ì„¸ìš”.";
    }
    if (risk === "med") {
        return "ì£¼ì˜! ì›€ì§ì„ì´ ë‹¤ì†Œ ë¶ˆì•ˆì •í•´ì§€ê³  ìˆì–´ìš”. ì¤‘ì‹¬ì„ ì¡ê³  ì²œì²œíˆ ì›€ì§ì´ëŠ” ê²ƒì´ ì¢‹ì•„ìš”.";
    }
    return "ğŸ’š ì•ˆì •ì ì´ì—ìš”! ì§€ê¸ˆ ìì„¸ë¥¼ ìœ ì§€í•˜ë©´ ë¶€ìƒ ìœ„í—˜ì´ ë‚®ì•„ìš”.";
}

// ======================= MQTT ë©”ì‹œì§€ ìˆ˜ì‹  =======================
client.on("message", (topic, msg) => {
    const d = JSON.parse(msg.toString());

    // ê·¸ë˜í”„ ì—…ë°ì´íŠ¸
    angleChart.data.labels.push("");
    rmsChart.data.labels.push("");
    mdfChart.data.labels.push("");

    angleChart.data.datasets[0].data.push(d.angleRate_peak_deg_s);
    rmsChart.data.datasets[0].data.push(d.emg_rms_drop_pct);
    mdfChart.data.datasets[0].data.push(d.mdf_drop_pct);

    angleChart.update();
    rmsChart.update();
    mdfChart.update();

    // Stick figure (using angle)
    drawStick(d.angleRate_peak_deg_s/3);

    // ì¹´ë“œ ì—…ë°ì´íŠ¸
    document.getElementById("val-angle").innerText = d.angleRate_peak_deg_s.toFixed(1);
    document.getElementById("val-rms").innerText   = d.emg_rms_drop_pct.toFixed(1);
    document.getElementById("val-mdf").innerText   = d.mdf_drop_pct.toFixed(1);
    document.getElementById("val-local").innerText = d.risk_local.imu2_gyr;

    document.getElementById("risk-angle").innerHTML = pillHtml(d.risk.angleRate);
    document.getElementById("risk-rms").innerHTML   = pillHtml(d.risk.rmsDrop);
    document.getElementById("risk-mdf").innerHTML   = pillHtml(d.risk.mdfDrop);
    document.getElementById("risk-local").innerHTML = pillHtml(d.risk_local.imu2_gyr);

    // Overall
    updateOverall(d.risk.overall);

    // Raw data
    if (d.raw) {
        document.getElementById("raw-gx1").innerText = d.raw.i1_gx;
        document.getElementById("raw-gy1").innerText = d.raw.i1_gy;
        document.getElementById("raw-gz1").innerText = d.raw.i1_gz;
        document.getElementById("raw-gx2").innerText = d.raw.i2_gx;
        document.getElementById("raw-gy2").innerText = d.raw.i2_gy;
        document.getElementById("raw-gz2").innerText = d.raw.i2_gz;
        document.getElementById("raw-emg").innerText = d.raw.emg_env;
    }

    // AI Comment
    document.getElementById("ai-comment").innerText =
        makeComment(d.risk.overall, d.angleRate_peak_deg_s, d.emg_rms_drop_pct, d.mdf_drop_pct);
});

</script>

</body>
</html>
