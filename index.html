<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Wearable Real-time Dashboard</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <style>
    :root {
      --ewha-green: #0f5d3f;
      --ewha-light: #f5faf7;
      --risk-low:   #27ae60;
      --risk-med:   #f2c94c;
      --risk-high:  #eb5757;
      --card-bg:    #ffffff;
      --border-soft:#e2e8f0;
      --text-main:  #1f2933;
      --text-soft:  #6b7280;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 24px;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Pretendard", "Noto Sans KR", sans-serif;
      background: radial-gradient(circle at top left, #e5f6ee 0, #f9fafb 52%);
      color: var(--text-main);
    }

    .page {
      max-width: 1100px;
      margin: 0 auto;
    }

    .header {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 16px;
    }

    .title {
      font-size: 28px;
      font-weight: 800;
      letter-spacing: 0.02em;
      color: var(--ewha-green);
    }

    .subtitle {
      font-size: 13px;
      color: var(--text-soft);
    }

    .grid {
      display: grid;
      grid-template-columns: 1.3fr 1fr;
      gap: 16px;
      align-items: flex-start;
    }

    .card {
      background: var(--card-bg);
      border-radius: 18px;
      padding: 16px 18px;
      box-shadow: 0 8px 24px rgba(15,93,63,0.08);
      border: 1px solid rgba(15,93,63,0.06);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 8px;
    }

    .card-title {
      font-size: 15px;
      font-weight: 600;
      color: var(--text-main);
    }

    .card-caption {
      font-size: 11px;
      color: var(--text-soft);
    }

    /* â”€â”€ Risk summary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .risk-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 600;
      color: #fff;
    }

    .risk-badge.low  { background: var(--risk-low);  }
    .risk-badge.med  { background: var(--risk-med);  color:#5c3b00;}
    .risk-badge.high { background: var(--risk-high); }

    .risk-number {
      font-size: 18px;
      font-weight: 700;
    }

    .risk-summary-text {
      font-size: 12px;
      margin-top: 6px;
      color: var(--text-soft);
      line-height: 1.6;
    }

    /* â”€â”€ Metrics + Gauges â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .metrics-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 8px;
    }

    .metric-row {
      padding: 8px 10px;
      border-radius: 12px;
      background: #f9fafb;
      border: 1px solid var(--border-soft);
    }

    .metric-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 4px;
      margin-bottom: 6px;
    }

    .metric-label {
      font-size: 12px;
      font-weight: 600;
    }

    .metric-unit {
      font-size: 11px;
      color: var(--text-soft);
      margin-left: 4px;
    }

    .metric-value {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-main);
    }

    .pill {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 1px 8px;
      border-radius: 999px;
      font-size: 11px;
      margin-left: 6px;
      min-width: 42px;
      text-align: center;
    }
    .pill.low  { background: rgba(39,174,96,0.1);  color: var(--risk-low);  }
    .pill.med  { background: rgba(242,201,76,0.15); color: #a86b00; }
    .pill.high { background: rgba(235,87,87,0.12); color: var(--risk-high); }

    .gauge {
      margin-top: 4px;
    }

    .gauge-track {
      width: 100%;
      height: 8px;
      border-radius: 999px;
      background: linear-gradient(
        to right,
        var(--risk-low) 0%,
        var(--risk-low) 33%,
        var(--risk-med) 33%,
        var(--risk-med) 66%,
        var(--risk-high) 66%,
        var(--risk-high) 100%
      );
      position: relative;
      overflow: hidden;
    }

    .gauge-marker {
      position: absolute;
      top: -3px;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      border: 2px solid #fff;
      background: #111827;
      box-shadow: 0 0 0 2px rgba(17,24,39,0.25);
      transform: translateX(-50%);
      transition: left 0.25s ease-out;
    }

    .gauge-threshold {
      position: absolute;
      top: 0;
      width: 2px;
      height: 100%;
      background: rgba(15,23,42,0.4);
      opacity: 0.7;
    }

    .gauge-labels {
      display: flex;
      justify-content: space-between;
      margin-top: 4px;
      font-size: 10px;
      color: var(--text-soft);
    }

    .gauge-legend {
      margin-top: 4px;
      font-size: 10px;
      color: var(--text-soft);
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .legend-dot {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 3px;
    }
    .legend-low  { background: var(--risk-low); }
    .legend-med  { background: var(--risk-med); }
    .legend-high { background: var(--risk-high); }

    /* â”€â”€ Text cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .text-list {
      list-style: none;
      padding-left: 0;
      margin: 0;
    }

    .text-list li {
      font-size: 12px;
      color: var(--text-soft);
      margin-bottom: 4px;
      line-height: 1.5;
    }

    .tag {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      border: 1px solid rgba(15,93,63,0.18);
      color: var(--ewha-green);
      background: rgba(15,93,63,0.05);
      margin-bottom: 6px;
    }

    .tag-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--ewha-green);
    }

    .ai-title {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .ai-body {
      font-size: 12px;
      color: var(--text-soft);
      line-height: 1.6;
      white-space: pre-line;
    }

    .footer {
      margin-top: 10px;
      font-size: 10px;
      color: var(--text-soft);
      text-align: right;
    }

  </style>
</head>
<body>
<div class="page">
  <div class="header">
    <div>
      <div class="title">ğŸƒâ€â™€ï¸ Wearable Real-time Dashboard</div>
      <div class="subtitle">IMU + EMG ê¸°ë°˜ ë¬´ë¦ ë¶€ìƒ ìœ„í—˜ ëª¨ë‹ˆí„°ë§</div>
    </div>
    <div class="subtitle" id="lastUpdated">Last update: -</div>
  </div>

  <div class="grid">
    <!-- ì™¼ìª½: ì¢…í•© ìœ„í—˜ + ê²Œì´ì§€ë“¤ -->
    <div class="card">
      <div class="card-header">
        <div class="card-title">ì¢…í•© ìœ„í—˜ë„</div>
        <span id="overallBadge" class="risk-badge low">
          <span class="risk-number" id="overallText">LOW</span>
        </span>
      </div>
      <div class="risk-summary-text" id="overallDesc">
        ì„¼ì„œ ì—°ê²° ì „ì´ê±°ë‚˜ ì•ˆì • ìƒíƒœì…ë‹ˆë‹¤. ì›€ì§ì„ì„ ì‹œì‘í•˜ë©´ ìœ„í—˜ë„ê°€ ê°±ì‹ ë©ë‹ˆë‹¤.
      </div>

      <hr style="border:none;border-top:1px dashed #e5e7eb;margin:10px 0 8px;">

      <div class="metrics-grid">
        <!-- ê°ì†ë„ -->
        <div class="metric-row">
          <div class="metric-header">
            <div>
              <span class="metric-label">ë¬´ë¦ ìƒëŒ€ ê°ì†ë„ í”¼í¬</span>
              <span class="metric-unit">(deg/s)</span>
              <span class="pill low" id="angleRatePill">low</span>
            </div>
            <div class="metric-value" id="angleRateValue">-</div>
          </div>
          <div class="gauge">
            <div class="gauge-track" id="angleGaugeTrack">
              <div class="gauge-threshold" id="angleLowLine"></div>
              <div class="gauge-threshold" id="angleMedLine"></div>
              <div class="gauge-marker" id="angleRateMarker" style="left:0%;"></div>
            </div>
            <div class="gauge-labels">
              <span>0</span>
              <span id="angleLowLabel"></span>
              <span id="angleMedLabel"></span>
              <span id="angleMaxLabel"></span>
            </div>
            <div class="gauge-legend">
              <span><span class="legend-dot legend-low"></span>ì•ˆì •</span>
              <span><span class="legend-dot legend-med"></span>ì£¼ì˜</span>
              <span><span class="legend-dot legend-high"></span>ìœ„í—˜</span>
            </div>
          </div>
        </div>

        <!-- RMS drop -->
        <div class="metric-row">
          <div class="metric-header">
            <div>
              <span class="metric-label">EMG RMS ê°ì†Œìœ¨</span>
              <span class="metric-unit">(%)</span>
              <span class="pill low" id="rmsDropPill">low</span>
            </div>
            <div class="metric-value" id="rmsDropValue">-</div>
          </div>
          <div class="gauge">
            <div class="gauge-track" id="rmsGaugeTrack">
              <div class="gauge-threshold" id="rmsLowLine"></div>
              <div class="gauge-threshold" id="rmsMedLine"></div>
              <div class="gauge-marker" id="rmsDropMarker" style="left:0%;"></div>
            </div>
            <div class="gauge-labels">
              <span>0</span>
              <span id="rmsLowLabel"></span>
              <span id="rmsMedLabel"></span>
              <span id="rmsMaxLabel"></span>
            </div>
            <div class="gauge-legend">
              <span><span class="legend-dot legend-low"></span>ê·¼í™œë™ ìœ ì§€</span>
              <span><span class="legend-dot legend-med"></span>í”¼ë¡œ ëˆ„ì </span>
              <span><span class="legend-dot legend-high"></span>í”¼ë¡œ ê³¼ë‹¤</span>
            </div>
          </div>
        </div>

        <!-- MDF drop -->
        <div class="metric-row">
          <div class="metric-header">
            <div>
              <span class="metric-label">EMG MDF ê°ì†Œìœ¨</span>
              <span class="metric-unit">(%)</span>
              <span class="pill low" id="mdfDropPill">low</span>
            </div>
            <div class="metric-value" id="mdfDropValue">-</div>
          </div>
          <div class="gauge">
            <div class="gauge-track" id="mdfGaugeTrack">
              <div class="gauge-threshold" id="mdfLowLine"></div>
              <div class="gauge-threshold" id="mdfMedLine"></div>
              <div class="gauge-marker" id="mdfDropMarker" style="left:0%;"></div>
            </div>
            <div class="gauge-labels">
              <span>0</span>
              <span id="mdfLowLabel"></span>
              <span id="mdfMedLabel"></span>
              <span id="mdfMaxLabel"></span>
            </div>
            <div class="gauge-legend">
              <span><span class="legend-dot legend-low"></span>ì£¼íŒŒìˆ˜ ì •ìƒ</span>
              <span><span class="legend-dot legend-med"></span>í”¼ë¡œ ì§•í›„</span>
              <span><span class="legend-dot legend-high"></span>í”¼ë¡œ ì‹¬í•¨</span>
            </div>
          </div>
        </div>

        <!-- Local risk -->
        <div class="metric-row">
          <div class="metric-header">
            <div>
              <span class="metric-label">Local Risk (IMU2 ìì´ë¡œ)</span>
            </div>
            <div class="metric-value" id="localRiskValue">-</div>
          </div>
          <div class="risk-summary-text" style="margin-top:2px;">
            ESP32ê°€ IMU2 ìì´ë¡œ í¬ê¸°ë§Œìœ¼ë¡œ í‰ê°€í•œ ê°„ë‹¨ ìœ„í—˜ë„ì…ë‹ˆë‹¤.
          </div>
        </div>
      </div>
    </div>

    <!-- ì˜¤ë¥¸ìª½: ë¶€ìƒ ì˜ˆë°© ê°€ì´ë“œ + AI ì½”ë©˜íŠ¸ -->
    <div class="card">
      <div class="card-header">
        <div class="card-title">ë¶€ìƒ ì˜ˆë°© ê°€ì´ë“œ</div>
      </div>
      <ul class="text-list" id="guideList">
        <li>ì„¼ì„œê°€ ì•ˆì •ì ìœ¼ë¡œ ìˆ˜ì§‘ë˜ë©´ ì´ ì˜ì—­ì— í˜„ì¬ ìœ„í—˜ ìš”ì¸ê³¼ ì˜ˆë°© í–‰ë™ì´ í‘œì‹œë©ë‹ˆë‹¤.</li>
      </ul>

      <hr style="border:none;border-top:1px dashed #e5e7eb;margin:10px 0 8px;">

      <div class="card-header" style="margin-bottom:4px;">
        <div class="card-title">AI ìì„¸ êµì • ì½”ë©˜íŠ¸</div>
      </div>
      <div class="tag" id="aiTag">
        <span class="tag-dot"></span>
        <span id="aiTagText">ì•ˆì „ ìì„¸</span>
      </div>
      <div class="ai-title" id="aiTitle">ì¢‹ì€ ìì„¸ë¥¼ ìœ ì§€í•˜ê³  ìˆì–´ìš”</div>
      <div class="ai-body" id="aiBody">
        ì›€ì§ì„ì„ ì‹œì‘í•˜ë©´ ì„¼ì„œ ê¸°ë°˜ìœ¼ë¡œ ìì„¸ í”¼ë“œë°±ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.
      </div>

      <div class="footer">
        ê¸°ì¤€ê°’ ê°ì†ë„: &lt;100 low Â· 100â€“200 med Â· â‰¥200 high<br>
        ê¸°ì¤€ê°’ RMS: &lt;20% low Â· 20â€“50% med Â· â‰¥50% high
      </div>
    </div>
  </div>
</div>

<script>
  // ---------- ê¸°ì¤€ ê°’ (Colabê³¼ ë§ì¶”ê¸°) ----------
  const TH_ANG = { low: 100, med: 200 };
  const TH_RMS = { low: 20,  med: 50  };
  const TH_MDF = { low: 10,  med: 20  };

  // ê²Œì´ì§€ ìµœëŒ€ í‘œì‹œ ë²”ìœ„(ì‹œê°í™”ìš©)
  const MAX_ANG = 300;  // deg/s
  const MAX_RMS = 80;   // %
  const MAX_MDF = 40;   // %

  // ---------- MQTT ì—°ê²° ----------
  const brokerUrl = 'wss://damoa.io:9002';
  const riskTopic = 'ewha/2270056/risk';   // Colabì´ ë°œí–‰

  const clientId = 'webdash-' + Math.random().toString(16).substr(2,8);
  const client = mqtt.connect(brokerUrl, { clientId });

  client.on('connect', () => {
    console.log('MQTT connected:', clientId);
    client.subscribe(riskTopic, err => {
      if (err) console.error('Subscribe error', err);
      else     console.log('Subscribed', riskTopic);
    });
  });

  client.on('message', (topic, payload) => {
    if (topic !== riskTopic) return;
    try {
      const data = JSON.parse(payload.toString());
      updateDashboardFromData(data);
    } catch (e) {
      console.error('Parse error', e);
    }
  });

  client.on('error', err => {
    console.error('MQTT error', err);
  });

  // ---------- UI ì—…ë°ì´íŠ¸ í•¨ìˆ˜ë“¤ ----------

  function setOverallRisk(overall) {
    const badge = document.getElementById('overallBadge');
    const text  = document.getElementById('overallText');
    const desc  = document.getElementById('overallDesc');

    badge.classList.remove('low','med','high');
    if (overall === 'high') {
      badge.classList.add('high');
      text.textContent = 'HIGH';
      desc.textContent =
        'ë¬´ë¦ ê°ì†ë„ ë˜ëŠ” ê·¼ í”¼ë¡œë„ê°€ ê¸°ì¤€ì„ í¬ê²Œ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤. ' +
        'ì¦‰ì‹œ ì†ë„ë¥¼ ì¤„ì´ê³ , ë™ì‘ì„ ë©ˆì¶˜ ë’¤ ì¶©ë¶„íˆ íœ´ì‹í•˜ì„¸ìš”.';
    } else if (overall === 'med') {
      badge.classList.add('med');
      text.textContent = 'MED';
      desc.textContent =
        'ì£¼ì˜ ë‹¨ê³„ì…ë‹ˆë‹¤. ë™ì‘ ë²”ìœ„ë¥¼ ì¤„ì´ê³ , ì†ë„ë¥¼ ì¡°ê¸ˆ ëŠ¦ì¶° ì£¼ì„¸ìš”. ' +
        'í†µì¦ì´ ëŠê»´ì§€ë©´ ì¦‰ì‹œ ë™ì‘ì„ ì¤‘ë‹¨í•˜ì„¸ìš”.';
    } else {
      badge.classList.add('low');
      text.textContent = 'LOW';
      desc.textContent =
        'í˜„ì¬ëŠ” ë¹„êµì  ì•ˆì •ì ì¸ ìƒíƒœì…ë‹ˆë‹¤. í†µì¦ ì—†ì´ ë¶€ë“œëŸ½ê²Œ ì›€ì§ì´ëŠ”ì§€ ê³„ì† ê´€ì°°í•˜ì„¸ìš”.';
    }
  }

  function setPill(id, level) {
    const el = document.getElementById(id);
    el.classList.remove('low','med','high');
    if (level === 'high') el.classList.add('high');
    else if (level === 'med') el.classList.add('med');
    else el.classList.add('low');
    el.textContent = level || '-';
  }

  function clamp(v, min, max) {
    return Math.min(max, Math.max(min, v));
  }

  function updateGauge(metricKey, value, th, maxRange, unit) {
    const valueSpan = document.getElementById(metricKey + 'Value');
    const marker    = document.getElementById(metricKey + 'Marker');
    const lowLine   = document.getElementById(metricKey + 'LowLine');
    const medLine   = document.getElementById(metricKey + 'MedLine');
    const lowLab    = document.getElementById(metricKey + 'LowLabel');
    const medLab    = document.getElementById(metricKey + 'MedLabel');
    const maxLab    = document.getElementById(metricKey + 'MaxLabel');

    if (value == null || isNaN(value)) {
      valueSpan.textContent = '-';
      marker.style.left = '0%';
    } else {
      valueSpan.textContent = value.toFixed(1) + ' ' + unit;
      const pct = clamp(value / maxRange * 100, 0, 100);
      marker.style.left = pct + '%';
    }

    // Low/Med ê¸°ì¤€ì¹˜ ìœ„ì¹˜
    const lowPct = clamp(th.low / maxRange * 100, 0, 100);
    const medPct = clamp(th.med / maxRange * 100, 0, 100);
    lowLine.style.left = lowPct + '%';
    medLine.style.left = medPct + '%';

    lowLab.textContent = th.low;
    medLab.textContent = th.med;
    maxLab.textContent = maxRange;
  }

  function buildGuideList(risk, data) {
    const list = document.getElementById('guideList');
    list.innerHTML = '';

    function add(text) {
      const li = document.createElement('li');
      li.textContent = text;
      list.appendChild(li);
    }

    const ar   = data.angleRate_peak_deg_s;
    const rms  = data.emg_rms_drop_pct;
    const mdf  = data.mdf_drop_pct;
    const loc  = data.risk_local && data.risk_local.imu2_gyr;

    if (!risk || risk.overall === 'low') {
      add('í˜„ì¬ëŠ” ì „ë°˜ì ìœ¼ë¡œ ì•ˆì • ìƒíƒœì…ë‹ˆë‹¤.');
      add('ë™ì‘ì´ ë¹¨ë¼ì§€ê±°ë‚˜ í”¼ë¡œê°€ ëˆ„ì ë˜ë©´ ì´ ì˜ì—­ì— ê²½ê³  ë©”ì‹œì§€ê°€ í‘œì‹œë©ë‹ˆë‹¤.');
      return;
    }

    // ì›ì¸ ë¶„ì„
    if (risk.angleRate === 'high') {
      add('ë¬´ë¦ ê°ì†ë„ê°€ ë†’ì•„ ê¸‰ê²©í•œ êµ´ê³¡/ì‹ ì „ì´ ë°œìƒí•˜ê³  ìˆìŠµë‹ˆë‹¤.');
    } else if (risk.angleRate === 'med') {
      add('ë¬´ë¦ ê°ì†ë„ê°€ ë‹¤ì†Œ ë¹ ë¥¸ í¸ì…ë‹ˆë‹¤. ë™ì‘ ë²”ìœ„ë¥¼ ì¤„ì´ê±°ë‚˜ ì†ë„ë¥¼ ëŠ¦ì¶°ì£¼ì„¸ìš”.');
    }

    if (risk.rmsDrop === 'high') {
      add('EMG RMS ê°ì†Œìœ¨ì´ ì»¤ì„œ ê·¼ í”¼ë¡œë„ê°€ ìƒë‹¹íˆ ë†’ìŠµë‹ˆë‹¤.');
    } else if (risk.rmsDrop === 'med') {
      add('ê·¼ í”¼ë¡œë„ê°€ ì„œì„œíˆ ëˆ„ì ë˜ê³  ìˆìŠµë‹ˆë‹¤.');
    }

    if (risk.mdfDrop === 'high') {
      add('MDF ê°ì†Œê°€ ì»¤ì„œ ê·¼ìœ¡ì˜ ì£¼íŒŒìˆ˜ ì„±ë¶„ì´ í”¼ë¡œ íŒ¨í„´ì— ê°€ê¹ê²Œ ë³€í–ˆìŠµë‹ˆë‹¤.');
    } else if (risk.mdfDrop === 'med') {
      add('ê·¼ í”¼ë¡œ ì§•í›„ê°€ ê´€ì°°ë©ë‹ˆë‹¤.');
    }

    if (loc === 'high') {
      add('Local risk(IMU2) ê¸°ì¤€ìœ¼ë¡œë„ ìœ„í—˜ ìˆ˜ì¤€ì…ë‹ˆë‹¤. ë™ì‘ì„ ì¦‰ì‹œ ì¤„ì—¬ ì£¼ì„¸ìš”.');
    }

    // ì¢…í•© í–‰ë™
    if (risk.overall === 'high') {
      add('âš  ë™ì‘ì„ ì¦‰ì‹œ ì¤‘ë‹¨í•˜ê³  20~30ì´ˆê°„ ë¬´ë¦ê³¼ í—ˆë²…ì§€ë¥¼ ì´ì™„ì‹œí‚¨ ë’¤ ë‹¤ì‹œ ì‹œì‘í•˜ì„¸ìš”.');
    } else if (risk.overall === 'med') {
      add('âš  ê°•ë„ë¥¼ 1~2ë‹¨ê³„ ë‚®ì¶”ê³ , í†µì¦ ì—¬ë¶€ë¥¼ ê³„ì† í™•ì¸í•˜ë©´ì„œ ì§„í–‰í•˜ì„¸ìš”.');
    }
  }

  function updateAiComment(risk) {
    const tag    = document.getElementById('aiTag');
    const tagTxt = document.getElementById('aiTagText');
    const title  = document.getElementById('aiTitle');
    const body   = document.getElementById('aiBody');

    if (!risk || risk.overall === 'low') {
      tagTxt.textContent = 'ì•ˆì „ ìì„¸';
      title.textContent  = 'ì¢‹ì€ ìì„¸ë¥¼ ìœ ì§€í•˜ê³  ìˆì–´ìš”';
      body.textContent =
        'í˜„ì¬ ì„¼ì„œ ê¸°ì¤€ìœ¼ë¡œëŠ” ë¹„êµì  ì•ˆì •ì ì¸ ìƒíƒœì…ë‹ˆë‹¤.\n' +
        '- ë¬´ë¦ì´ ë°œëë³´ë‹¤ ê³¼ë„í•˜ê²Œ ì•ìœ¼ë¡œ ë‚˜ê°€ì§€ ì•ŠëŠ”ì§€\n' +
        '- í—ˆë¦¬ê°€ ê³¼ë„í•˜ê²Œ êµ½ê±°ë‚˜ ì –í˜€ì§€ì§€ ì•ŠëŠ”ì§€\n' +
        '- í†µì¦ ì—†ì´ ë¶€ë“œëŸ½ê²Œ ì›€ì§ì´ëŠ”ì§€\n' +
        'ì´ ì„¸ ê°€ì§€ë¥¼ ê³„ì† ì²´í¬í•´ ì£¼ì„¸ìš”.';
    } else if (risk.overall === 'med') {
      tagTxt.textContent = 'ì£¼ì˜ ìì„¸';
      title.textContent  = 'ì†ë„ì™€ ë²”ìœ„ë¥¼ í•œ ë‹¨ê³„ ì¤„ì—¬ë³´ì„¸ìš”';
      body.textContent =
        'ë¬´ë¦ ì£¼ë³€ì— ë¶€ë‹´ì´ ëŠ˜ì–´ë‚˜ê³  ìˆìŠµë‹ˆë‹¤.\n' +
        '- ë™ì‘ ì†ë„ë¥¼ 20~30% ì •ë„ ì¤„ì´ê³ \n' +
        '- ë³´í­Â·ìŠ¤ì¿¼íŠ¸ ê¹Šì´ë¥¼ ì•½ê°„ ì¤„ì—¬ ë³´ì„¸ìš”.\n' +
        'ì–‘ìª½ ë¬´ë¦ì˜ ì²´ì¤‘ ë¶„ë°°ë¥¼ ê· ë“±í•˜ê²Œ ìœ ì§€í•˜ëŠ” ê²ƒë„ ì¤‘ìš”í•©ë‹ˆë‹¤.';
    } else {
      tagTxt.textContent = 'ê³ ìœ„í—˜ ìì„¸';
      title.textContent  = 'ë‹¹ì¥ ë™ì‘ì„ ì¤„ì´ëŠ” ê²ƒì´ ì¢‹ì•„ìš”';
      body.textContent =
        'ì„¼ì„œ ê¸°ì¤€ìœ¼ë¡œëŠ” ë¬´ë¦ì— ê³¼ë¶€í•˜ê°€ ê±¸ë¦° ìƒíƒœì…ë‹ˆë‹¤.\n' +
        '- ë™ì‘ì„ ì¦‰ì‹œ ë©ˆì¶”ê³  20ì´ˆ ì´ìƒ íœ´ì‹\n' +
        '- í—ˆë²…ì§€ ì•/ì˜† ê·¼ìœ¡ì„ ê°€ë³ê²Œ ìŠ¤íŠ¸ë ˆì¹­\n' +
        'í†µì¦ì´ ê³„ì†ëœë‹¤ë©´ ì˜¤ëŠ˜ì€ ê°•ë„ ë†’ì€ ë™ì‘ì„ í”¼í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.';
    }
  }

  function updateDashboardFromData(payload) {
    const risk = payload.risk || {};
    const overall = risk.overall || 'low';

    setOverallRisk(overall);

    // ê°ì†ë„ ê²Œì´ì§€
    updateGauge('angleRate',
      payload.angleRate_peak_deg_s,
      TH_ANG,
      MAX_ANG,
      'deg/s'
    );
    setPill('angleRatePill', risk.angleRate || 'unknown');

    // RMS drop ê²Œì´ì§€
    updateGauge('rmsDrop',
      payload.emg_rms_drop_pct,
      TH_RMS,
      MAX_RMS,
      '%'
    );
    setPill('rmsDropPill', risk.rmsDrop || 'unknown');

    // MDF drop ê²Œì´ì§€
    updateGauge('mdfDrop',
      payload.mdf_drop_pct,
      TH_MDF,
      MAX_MDF,
      '%'
    );
    setPill('mdfDropPill', risk.mdfDrop || 'unknown');

    // Local risk
    const loc = payload.risk_local && payload.risk_local.imu2_gyr;
    document.getElementById('localRiskValue').textContent = loc || '-';

    // ê°€ì´ë“œ & AI ì½”ë©˜íŠ¸
    buildGuideList(risk, payload);
    updateAiComment(risk);

    // ì‹œê°„ ì—…ë°ì´íŠ¸
    const t = new Date();
    document.getElementById('lastUpdated').textContent =
      'Last update: ' + t.toLocaleTimeString();
  }
</script>
</body>
</html>
