<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>ì•ˆë‹¤ì¹˜ì¡° â€“ Wearable Real-time Dashboard</title>

  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

  <style>
    /* ===== Global ===== */
    * { box-sizing:border-box; margin:0; padding:0; }
    body {
      font-family:-apple-system,BlinkMacSystemFont,"Pretendard","Noto Sans KR",system-ui,sans-serif;
      background:radial-gradient(circle at 20% 10%, #E7F4EF, #F8FAF9 60%);
      color:#1f2a2c;
      padding:24px;
    }
    .page { max-width:1100px; margin:0 auto; }

    /* ===== Header ===== */
    .header {
      display:flex; justify-content:space-between; align-items:flex-start;
      margin-bottom:20px;
    }
    .brand-left { display:flex; flex-direction:column; gap:4px; }
    .brand-top { display:flex; align-items:center; gap:12px; margin-bottom:4px; }
    .andachi-logo { width:48px; height:48px; }
    .team-badge {
      padding:4px 12px; border-radius:999px;
      background:rgba(15, 76, 58, 0.10);
      border:1px solid rgba(15, 76, 58, 0.24);
      color:#0F4C3A; font-size:13px; font-weight:600;
    }
    .title { font-size:30px; font-weight:800; color:#0F4C3A; }
    .subtitle { font-size:13px; color:#5F6A67; }

    /* ===== Layout ===== */
    .main-grid {
      display:grid;
      grid-template-columns:2.1fr 1.2fr;
      gap:16px;
    }
    @media(max-width:900px){
      .main-grid { grid-template-columns:1fr; }
    }

    /* ===== Card ===== */
    .card {
      background:#fff;
      padding:18px 20px;
      border-radius:18px;
      box-shadow:0 10px 25px rgba(15,76,58,0.07);
    }
    .card-title { font-size:18px; font-weight:700; }
    .card-sub { font-size:13px; color:#6b7a78; margin-top:8px; line-height:1.45; }

    /* ===== Pill ===== */
    .pill {
      padding:4px 12px; border-radius:999px;
      font-size:12px; font-weight:700; text-transform:uppercase;
      display:inline-flex; align-items:center;
    }
    .pill-low{ background:#E4F6EC; color:#0F6A3A; }
    .pill-med{ background:#FFF3D6; color:#A76B11; }
    .pill-high{ background:#FFE1E1; color:#B3261E; }
    .emg-pill{ font-size:11px; padding:2px 8px; margin-left:6px; }

    /* ===== Metric ===== */
    .metric-row{ margin-top:18px; }
    .metric-top{ display:flex; justify-content:space-between; margin-bottom:6px; }
    .metric-label{ font-size:14px; font-weight:600; }
    .metric-unit{ font-size:12px; color:#8a9896; margin-left:4px; }
    .metric-value{ font-size:13px; color:#4d5b59; }

    .scale-bar{
      height:10px; border-radius:999px; overflow:hidden;
      background:linear-gradient(
        to right,
        #C3E8D2 0%, #C3E8D2 33%,
        #FFE5AA 33%, #FFE5AA 66%,
        #FFC1C1 66%, #FFC1C1 100%
      );
      margin-bottom:4px; position:relative;
    }
    .scale-marker{
      position:absolute; top:-4px;
      height:18px; width:0; border-left:3px solid #222;
    }
    .scale-caption{
      display:flex; justify-content:space-between;
      font-size:11px; color:#8a9896;
    }
    .dot{ font-size:10px; margin-right:4px; }

    /* ===== EMG Report ===== */
    .emg-summary-row{
      margin-top:22px; padding:12px 14px;
      border-radius:14px; background:#F7FBFA;
      border:1px dashed #C7D9D4;
    }
    .emg-summary-title{
      font-size:13px; font-weight:600; color:#26413C; margin-bottom:6px;
    }
    .emg-summary-text{ font-size:11px; line-height:1.45; }
    .hint-muted{ font-size:11px; color:#9AA7A4; margin-top:4px; white-space:pre-line; }

    .lock-btn{
      margin-top:10px; padding:6px 12px; font-size:12px;
      border-radius:999px; border:1px solid #C7D9D4;
      background:#F7FBFA; cursor:pointer;
    }
    .lock-btn:disabled{ opacity:0.6; cursor:default; }

    /* ===== Coaching ===== */
    .guide-title{ font-size:17px; font-weight:700; margin-bottom:6px; }
    .guide-text{ font-size:13px; color:#5F6A67; white-space:pre-line; }
    .divider{ height:1px; background:#EEF3F2; margin:10px 0 12px; }

    .coach-status-pill{
      padding:4px 10px; border-radius:999px;
      display:inline-flex; align-items:center;
      font-size:12px; margin-bottom:6px;
      background:#E7F4EF;
    }
    .coach-status-pill-dot{
      width:7px; height:7px; border-radius:999px;
      background:#18A05D; margin-right:6px;
    }
    .coach-title{ font-size:15px; font-weight:700; margin-bottom:4px; }
    .coach-body{ font-size:13px; line-height:1.5; white-space:pre-line; }
    .coach-tips{ font-size:11px; color:#9aa7a4; white-space:pre-line; }
  </style>
</head>

<body>
<div class="page">

  <!-- HEADER -->
  <header class="header">
    <div class="brand-left">
      <div class="brand-top">

        <!-- â­ ë³µì›ëœ ANDACHI ë¡œê³  -->
        <svg class="andachi-logo" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" aria-label="ANDACHI logo">
          <circle cx="32" cy="32" r="30" fill="#0F4C3A" />
          <path
            d="M32 14
               L21 18
               v12
               c0 8.5 5 14.5 11 17.5
               c6-3 11-9 11-17.5
               V18
               Z"
            fill="#F8FAF9"
          />
          <path
            d="M27 24
               Q 32 24 34 28
               Q 36 32 33 36
               L 30 40"
            fill="none"
            stroke="#0F4C3A"
            stroke-width="2.8"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
          <circle cx="33" cy="29.5" r="2.4" fill="#0F4C3A" />
          <path
            d="M38 19
               q 5 -3 9 -1
               q -2.5 5 -7.5 6
               q -1.5 -2.5 -1.5 -5z"
            fill="#4E8A6D"
          />
        </svg>

        <div class="team-badge">ì•ˆë‹¤ì¹˜ì¡° ANDACHI</div>
      </div>

      <div class="title">Wearable Real-time Dashboard</div>
      <div class="subtitle">IMU + EMG ê¸°ë°˜ ì‹¤ì‹œê°„ ë¬´ë¦ ë¶€ìƒ ìœ„í—˜ ëª¨ë‹ˆí„°ë§</div>
    </div>

    <div class="header-right">
      Last update: <span id="lastUpdated">-</span>
    </div>
  </header>

  <!-- MAIN GRID -->
  <div class="main-grid">

    <!-- LEFT -->
    <div>
      <div class="card">

        <div class="card-title" style="display:flex; flex-direction:column; line-height:1.2;">
          ì‹¤ì‹œê°„ ë¬´ë¦ ë¶€ìƒ ìœ„í—˜ë„
          <span style="font-size:10px; color:#C7CECC; margin-top:3px;">
            (ë¬´ë¦ ìƒëŒ€ ê°ì†ë„ í”¼í¬ê°’ ê¸°ë°˜)
          </span>
        </div>

        <!-- ANGLE RATE -->
        <div class="metric-row">
          <div class="metric-top">
            <div>
              <span class="metric-label">ë¬´ë¦ ìƒëŒ€ ê°ì†ë„ í”¼í¬</span>
              <span class="metric-unit">(deg/s)</span>
            </div>

            <div class="metric-value">
              <span id="angleRateVal">-</span>
              <span> Â· </span>
              <span id="angleRateLevel" class="pill pill-low" style="font-size:14px; padding:4px 12px;">LOW</span>
            </div>
          </div>

          <div class="scale-bar">
            <div id="angleRateMarker" class="scale-marker"></div>
          </div>

          <div class="scale-caption">
            <span class="safe"><span class="dot">â—</span>ì•ˆì • (&lt;100)</span>
            <span class="warn"><span class="dot">â—</span>ì£¼ì˜ (100â€“200)</span>
            <span class="danger"><span class="dot">â—</span>ìœ„í—˜ (&gt;=200)</span>
          </div>
        </div>

        <div class="card-sub">
          ì°©ì§€Â·ë°©í–¥ì „í™˜ ìˆœê°„ì— ë¬´ë¦ì´ ì–¼ë§ˆë‚˜ ë¹ ë¥´ê²Œ êº¾ì˜€ë‹¤ í´ì§€ëŠ”ì§€ë¥¼ ë³´ì—¬ì£¼ëŠ” ê°’ì…ë‹ˆë‹¤.
          ì°©ì§€ ì¶©ê²©ì´ë‚˜ ë°©í–¥ ì „í™˜ ë¶€í•˜ê°€ í´ìˆ˜ë¡ ì´ ê°’ì´ ë†’ê²Œ ë‚˜íƒ€ë‚  ìˆ˜ ìˆì–´ìš”.
        </div>

        <!-- EMG REPORT -->
        <div class="metric-row emg-summary-row">
          <div class="emg-summary-title">EMG ì„¸ì…˜ í”¼ë¡œ ë¶„ì„ ë¦¬í¬íŠ¸</div>

          <div class="emg-summary-text">
            RMS ì¦ê°€ìœ¨: <span id="emgRmsReport">-</span>%
            <span id="emgRmsLevel" class="pill emg-pill pill-low" style="display:none;">LOW</span><br/>

            MDF ê°ì†Œìœ¨: <span id="emgMdfReport">-</span>%
            <span id="emgMdfLevel" class="pill emg-pill pill-low" style="display:none;">LOW</span>
          </div>

          <div class="hint-muted">
            ìš´ë™ ì¢…ë£Œ í›„ ë²„íŠ¼ì„ ëˆŒëŸ¬ í•´ë‹¹ ì‹œì ì˜ ê°’ì„ ì„¸ì…˜ ë¦¬í¬íŠ¸ë¡œ ì €ì¥í•˜ì„¸ìš”.
          </div>

          <button id="lockEmgReportBtn" type="button" class="lock-btn">
            ìš´ë™ ì¢…ë£Œ Â· ë¦¬í¬íŠ¸ ê³ ì •í•˜ê¸°
          </button>

          <div id="lockStatusText" class="hint-muted">
            ì•„ì§ ì„¸ì…˜ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤. ìš´ë™ì„ ë§ˆì¹˜ë©´ ìœ„ ë²„íŠ¼ì„ ëˆŒëŸ¬ ë¦¬í¬íŠ¸ë¥¼ ê³ ì •í•˜ì„¸ìš”.
          </div>
        </div>
      </div>
    </div>

    <!-- RIGHT -->
    <div>
      <div class="card">
        <div class="guide-title">ë¶€ìƒ ì˜ˆë°© ê°€ì´ë“œ</div>
        <div id="guideText" class="guide-text">
          ì„¼ì„œê°€ ì•ˆì •ì ìœ¼ë¡œ ìˆ˜ì§‘ë˜ë©´ ì´ ì˜ì—­ì— í˜„ì¬ ìœ„í—˜ ìš”ì¸ê³¼ ì˜ˆë°© í–‰ë™ì´ í‘œì‹œë©ë‹ˆë‹¤.
        </div>

        <div class="divider"></div>

        <div class="guide-title" style="font-size:16px;">AI ìì„¸ êµì • ì½”ë©˜íŠ¸</div>
        <div id="coachStatusPill" class="coach-status-pill">
          <span class="coach-status-pill-dot"></span>
          <span id="coachStatusText">ì•ˆì „ ìì„¸</span>
        </div>

        <div id="coachTitle" class="coach-title">ì¢‹ì€ ìì„¸ë¥¼ ìœ ì§€í•˜ê³  ìˆì–´ìš”</div>
        <div id="coachBody" class="coach-body">
          ì›€ì§ì„ì„ ì‹œì‘í•˜ë©´ ì„¼ì„œ ê¸°ë°˜ìœ¼ë¡œ ìì„¸ í”¼ë“œë°±ì´ í‘œì‹œë©ë‹ˆë‹¤.
        </div>

        <div id="coachTips" class="coach-tips">
          ê¸°ì¤€ê°’ ê°ì†ë„: &lt;100 low Â· 100â€“200 med Â· â‰¥200 high
          EMG í”¼ë¡œë„ëŠ” RMS ì¦ê°€ìœ¨Â·MDF ê°ì†Œìœ¨ë¡œ ìš”ì•½ë©ë‹ˆë‹¤.
        </div>
      </div>
    </div>

  </div>
</div>

<!-- ================= JS ================= -->
<script>
const BROKER_URL="wss://damoa.io:9002";
const TOPIC="ewha/2270056/risk";

const clientId="andachi-"+Math.random().toString(16).slice(2,10);
const client=mqtt.connect(BROKER_URL,{clientId});

let emgReportLocked=false;
let emgSnapshot=null;

/* ===== COMMON ===== */
function fmt(v,d=1){ return (!isFinite(v))? "-" : v.toFixed(d); }
function levelClass(lv){ return lv==="high"?"pill-high":lv==="med"?"pill-med":"pill-low"; }
function clamp(v){ return Math.max(0,Math.min(100,v)); }

/* =====================================================================
   NEW EMG í•´ì„ í•¨ìˆ˜ â€” ëª¨ë“  ì¼€ì´ìŠ¤ ì •í™•íˆ ë°˜ì˜ (ë– ë¼ ìš”ì²­ + ê³¼ë¶€í•˜/í”¼ë¡œ ë¶„ë¦¬)
   ===================================================================== */
function getEmgSessionSummary(rms, mdf){
  const R=isFinite(rms)? rms : null;
  const M=isFinite(mdf)? mdf : null;

  let rmsLine="", mdfLine="", rec="";

  /* RMS í•´ì„ */
  if (R===null){
    rmsLine="RMS ì¦ê°€ìœ¨ì„ ì¶”ì •í•˜ê¸°ì— ë°ì´í„°ê°€ ì¶©ë¶„í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.";
  }
  else if (R<10){
    rmsLine=`RMSëŠ” ì•½ ${R.toFixed(1)}% ì¦ê°€í•´, ê·¼ ì‚¬ìš©ëŸ‰ ë³€í™”ê°€ í¬ì§€ ì•Šì€ í¸ì…ë‹ˆë‹¤.`;
  }
  else if (R<30){
    rmsLine=`RMSëŠ” ì•½ ${R.toFixed(1)}% ì¦ê°€í•´, í›„ë°˜ë¶€ì— ê·¼ ì‚¬ìš©ëŸ‰ì´ ë‹¤ì†Œ ì¦ê°€í•œ ìƒíƒœì…ë‹ˆë‹¤.`;
  }
  else{
    rmsLine=`RMSëŠ” ì•½ ${R.toFixed(1)}% ì¦ê°€í•´, ìˆœê°„ì ì¸ ê·¼ ì‚¬ìš©ëŸ‰ì´ í¬ê²Œ ì¦ê°€í•œ ìƒíƒœì…ë‹ˆë‹¤.`;
  }

  /* MDF í•´ì„ */
  if (M===null){
    mdfLine="MDF ê°ì†Œìœ¨ì„ ì•ˆì •ì ìœ¼ë¡œ ì¶”ì •í•˜ê¸° ì–´ë ¤ì› ìŠµë‹ˆë‹¤.";
  }
  else if (M<10){
    mdfLine=`MDFëŠ” ì•½ ${M.toFixed(1)}% ê°ì†Œí•´, í”¼ë¡œ ëˆ„ì ì´ í¬ì§€ ì•Šì€ í¸ì…ë‹ˆë‹¤.`;
  }
  else if (M<20){
    mdfLine=`MDFëŠ” ì•½ ${M.toFixed(1)}% ê°ì†Œí•´, í”¼ë¡œê°€ ì„œì„œíˆ ëˆ„ì ë˜ëŠ” íë¦„ì…ë‹ˆë‹¤.`;
  }
  else{
    mdfLine=`MDFëŠ” ì•½ ${M.toFixed(1)}% ê°ì†Œí•´, í›„ë°˜ë¶€ì— í”¼ë¡œ ëˆ„ì ì´ ëšœë ·í•˜ê²Œ ì¦ê°€í•œ ìƒíƒœì…ë‹ˆë‹¤.`;
  }

  /* ==========================================================
     ğŸ§  ì¢…í•© ê¶Œì¥ í–‰ë™ (ì¼€ì´ìŠ¤ ì„¸ë¶„í™”)
     ========================================================== */

  // CASE 1 â€” RMS high + MDF high
  if ((R!==null && R>=30) && (M!==null && M>=20)){
    rec =
      "ê·¼ ì‚¬ìš©ëŸ‰ ì¦ê°€ì™€ í”¼ë¡œ ëˆ„ì ì´ ëª¨ë‘ í¬ê²Œ ë‚˜íƒ€ë‚œ ì„¸ì…˜ì…ë‹ˆë‹¤.\n" +
      "ì´í›„ í›ˆë ¨ì€ ê°•í•œ ê°•ë„ë¥¼ í”¼í•˜ê³ , ìŠ¤íŠ¸ë ˆì¹­Â·í¼ë¡¤ë§Â·ì¶©ë¶„í•œ íœ´ì‹ì— ì§‘ì¤‘í•´ ì£¼ì„¸ìš”.\n" +
      "ë¬´ë¦ ì•ˆì •ì„±ì„ ìœ„í•´ ë‹¤ìŒ ëŸ¬ë‹ì€ íšŒë³µ í›„ ì§„í–‰í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.";
  }

  // CASE 2 â€” RMS high + MDF low/med
  else if ((R!==null && R>=30) && (M!==null && M<20)){
    rec =
      "ê·¼ ì‚¬ìš©ëŸ‰ì´ í¬ê²Œ ì¦ê°€í•œ ì„¸ì…˜ì…ë‹ˆë‹¤.\n" +
      "í”¼ë¡œ ëˆ„ì (MDF)ì€ í¬ì§€ ì•Šì§€ë§Œ ìˆœê°„ì ì¸ ê·¼ ë¶€í•˜ê°€ ë†’ì•˜ì„ ìˆ˜ ìˆì–´,\n" +
      "ë‹¤ìŒ ì„¸ì…˜ì€ ê°•ë„ë¥¼ ì•½ê°„ ë‚®ì¶”ê³  íšŒë³µ ì‹œê°„ì„ í™•ë³´í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.";
  }

  // CASE 3 â€” RMS low/med + MDF high
  else if ((R===null || R<30) && (M!==null && M>=20)){
    rec =
      "í”¼ë¡œ ëˆ„ì ì´ ëšœë ·í•˜ê²Œ ì¦ê°€í•œ ì„¸ì…˜ì…ë‹ˆë‹¤.\n" +
      "ê·¼ ì§€ì§€ë ¥ì´ ë–¨ì–´ì§€ëŠ” ë‹¨ê³„ì´ë¯€ë¡œ ê³¼ë¶€í•˜ ë™ì‘ì€ í”¼í•˜ê³ ,\n" +
      "ì¶©ë¶„í•œ íœ´ì‹ê³¼ ìŠ¤íŠ¸ë ˆì¹­ì„ ìš°ì„ í•´ì£¼ì„¸ìš”.";
  }

  // CASE 4 â€” ë‘˜ ì¤‘ í•˜ë‚˜ë¼ë„ medium êµ¬ê°„
  else if ((R!==null && R>=10) || (M!==null && M>=10)){
    rec =
      "ê·¼ ì‚¬ìš©ëŸ‰ ë˜ëŠ” í”¼ë¡œê°€ ì„œì„œíˆ ëˆ„ì ë˜ëŠ” íë¦„ì…ë‹ˆë‹¤.\n" +
      "ë‹¤ìŒ ëŸ¬ë‹ ì „ ì›Œë°ì—… ì‹œê°„ì„ ì¡°ê¸ˆ ë” í™•ë³´í•˜ê³ ,\n" +
      "ì´ë²ˆ ì£¼ëŠ” ê°•ë„ì™€ ê±°ë¦¬ë¥¼ ë³´ìˆ˜ì ìœ¼ë¡œ ì¡°ì ˆí•´ ì£¼ì„¸ìš”.";
  }

  // CASE 5 â€” ë‘˜ ë‹¤ low
  else{
    rec =
      "í”¼ë¡œ ëˆ„ì ì´ í¬ì§€ ì•Šì€ ì•ˆì •ì ì¸ ì„¸ì…˜ì´ì—ˆìŠµë‹ˆë‹¤.\n" +
      "ì§€ê¸ˆì²˜ëŸ¼ ë¬´ë¦¬í•˜ì§€ ì•ŠëŠ” ë²”ìœ„ì—ì„œ ì ì§„ì ìœ¼ë¡œ í›ˆë ¨ì„ ì´ì–´ê°€ë©´ ì¢‹ìŠµë‹ˆë‹¤.";
  }

  return `ì„¸ì…˜ ë¦¬í¬íŠ¸ê°€ ê³ ì •ë˜ì—ˆìŠµë‹ˆë‹¤.\n\n${rmsLine}\n${mdfLine}\n\n${rec}`;
}

/* ============================ EMG RENDER ============================ */
function renderEmg(rms,mdf,rLv,mLv){
  document.getElementById("emgRmsReport").textContent=fmt(rms);
  document.getElementById("emgMdfReport").textContent=fmt(mdf);

  const rP=document.getElementById("emgRmsLevel");
  const mP=document.getElementById("emgMdfLevel");

  if(!isFinite(rms)) rP.style.display="none";
  else{
    rP.style.display="inline-flex";
    rP.className="pill emg-pill "+levelClass(rLv);
    rP.textContent=rLv.toUpperCase();
  }

  if(!isFinite(mdf)) mP.style.display="none";
  else{
    mP.style.display="inline-flex";
    mP.className="pill emg-pill "+levelClass(mLv);
    mP.textContent=mLv.toUpperCase();
  }
}

/* ===================== Coaching ===================== */
/* ===================== Coaching ===================== */
function getCoaching(overall, aLv, rLv, mLv){
  let status, title, body, guide;

  if (overall === "low") {
    // ğŸŸ¢ LOW
    status = "ğŸŸ¢ LOW ìœ„í—˜ë„";
    title  = "í˜„ì¬ ìƒíƒœ ì–‘í˜¸í•©ë‹ˆë‹¤.";
    body   = "í˜„ì¬ ìƒíƒœê°€ ë¹„êµì  ì•ˆì •ì ì…ë‹ˆë‹¤.\nê°€ë³ê²Œ ë‹¬ë¦¬ê¸°ë¥¼ ì´ì–´ê°€ë˜, ìŠ¤íŠ¸ë ˆì¹­ê³¼ í™Â·ì½”ì–´ ìš´ë™ì„ í•¨ê»˜ í•´ ì£¼ë©´ ì¢‹ìŠµë‹ˆë‹¤.";

    guide =
      "âœ… ê¶Œì¥ í–‰ë™\n" +
      "â€¢ ë‹¬ë¦¬ê¸° ì „ ë™ì  ì›Œë°ì—… (ì˜ˆ: ë ˆê·¸ ìŠ¤ìœ™, í•˜ì´ ë‹ˆ)\n" +
      "â€¢ ë‹¬ë¦¬ê¸° í›„ í–„ìŠ¤íŠ¸ë§Â·ì¢…ì•„ë¦¬Â·ê³ ê´€ì ˆ ìŠ¤íŠ¸ë ˆì¹­ 20~30ì´ˆ ìœ ì§€\n" +
      "â€¢ ì£¼ê°„ í›ˆë ¨ ê±°ë¦¬/ê°•ë„ëŠ” ê¸‰ê²©íˆ ì˜¬ë¦¬ì§€ ë§ê³ , í‰ì†Œ ëŒ€ë¹„ +10% ì´ë‚´ì—ì„œ ì¡°ì ˆí•˜ê¸°";
  }
  else if (overall === "med") {
    // ğŸŸ¡ MEDIUM
    status = "ğŸŸ¡ MEDIUM ìœ„í—˜ë„";
    title  = "í”¼ë¡œë‚˜ ì¶©ê²©ëŸ‰ì´ ì¦ê°€ëœ ìƒíƒœì…ë‹ˆë‹¤.";
    body   =
      "ë¬´ë¦ì— ì „ë‹¬ë˜ëŠ” ìˆœê°„ ì¶©ê²©ì´ë‚˜ êµ½í˜ ì†ë„ê°€ í‰ì†Œë³´ë‹¤ ì»¤ì§„ ì‹ í˜¸ì…ë‹ˆë‹¤.\n" +
      "ì˜¤ëŠ˜ì€ ê±°ë¦¬ë¥¼ ì¤„ì´ê±°ë‚˜ í˜ì´ìŠ¤ë¥¼ ë‚®ì¶”ê³ , í™Â·ì¢…ì•„ë¦¬ ê·¼ë ¥ìš´ë™ì„ í•¨ê»˜ í•˜ëŠ” í¸ì´ ì•ˆì „í•©ë‹ˆë‹¤.";

    guide =
      "âœ… ê¶Œì¥ í–‰ë™\n" +
      "â€¢ ì˜¤ëŠ˜ì€ ê±°ë¦¬ë‚˜ ê°•ë„ë¥¼ ì¤„ì¸ ëŸ¬ë‹ (ì˜ˆ: í‰ì†Œì˜ ì•½ 70~80%)\n" +
      "â€¢ í™Â·ì¢…ì•„ë¦¬ ê·¼ë ¥ìš´ë™ 1~2ì„¸íŠ¸ ì¶”ê°€ (ì˜ˆ: í™ ì“°ëŸ¬ìŠ¤íŠ¸, ì¹´í”„ ë ˆì´ì¦ˆ)\n" +
      "â€¢ ë‹¬ë¦¬ê¸° ì‹œ ë³´í­ì„ ì¡°ê¸ˆ ì¤„ì´ê³ , ì¼€ì´ë˜ìŠ¤ë¥¼ í‰ì†Œë³´ë‹¤ ì•½ +5~10% ë†’ì—¬ë³´ê¸°";
  }
  else {
    // ğŸ”´ HIGH
    status = "ğŸ”´ HIGH ìœ„í—˜ë„";
    title  = "ë¶€ìƒ ìœ„í—˜ì´ ë†’ì€ ìƒíƒœì…ë‹ˆë‹¤.";
    body   =
      "ë¬´ë¦ì— ê±¸ë¦¬ëŠ” íšŒì „ ë¶€í•˜ì™€ í”¼ë¡œë„ê°€ ëª¨ë‘ ë†’ì•„ì§„ ìƒíƒœì…ë‹ˆë‹¤.\n" +
      "ì˜¤ëŠ˜ì€ ë‹¬ë¦¬ê¸°ë¥¼ í”¼í•˜ê³ , ì €ê°•ë„ í¬ë¡œìŠ¤ íŠ¸ë ˆì´ë‹ê³¼ íšŒë³µ ìœ„ì£¼ì˜ ìš´ë™ì— ì§‘ì¤‘í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.";

    guide =
      "âœ… ê¶Œì¥ í–‰ë™\n" +
      "â€¢ ì˜¤ëŠ˜ì€ ë‹¬ë¦¬ê¸° ëŒ€ì‹  ìì „ê±°Â·ìˆ˜ì˜ ë“± ê´€ì ˆ ë¶€ë‹´ì´ ì ì€ ìš´ë™ìœ¼ë¡œ ëŒ€ì²´\n" +
      "â€¢ ì°©ì§€ íŒ¨í„´Â·ë³´í­Â·ì¼€ì´ë˜ìŠ¤ë¥¼ í•¨ê»˜ ì ê²€í•˜ë©°, ë³´í­ì€ ì¤„ì´ê³  ì¼€ì´ë˜ìŠ¤ëŠ” í‰ì†Œë³´ë‹¤ +10% ì´ìƒìœ¼ë¡œ ì¡°ì •\n" +
      "â€¢ í™Â·í–„ìŠ¤íŠ¸ë§Â·ì¢…ì•„ë¦¬ ìœ„ì£¼ ê·¼ë ¥ìš´ë™ê³¼ ì¶©ë¶„í•œ ìŠ¤íŠ¸ë ˆì¹­ìœ¼ë¡œ íšŒë³µì— ì§‘ì¤‘í•˜ê¸°";
  }

  return { status, title, body, guide };
}


/* ===================== DASHBOARD UPDATE ===================== */
client.on("connect",()=>{
  client.subscribe(TOPIC);
});
client.on("message",(t,msg)=>{
  if(t!==TOPIC) return;
  updateDashboard(JSON.parse(msg.toString()));
});

function updateDashboard(p){

  const ts=p.ts||Date.now();
  const d=new Date(ts);
  document.getElementById("lastUpdated").textContent=
    `${d.getHours().toString().padStart(2,"0")}:${d.getMinutes().toString().padStart(2,"0")}:${d.getSeconds().toString().padStart(2,"0")}`;

  const angle=p.angleRate_peak_deg_s;
  const rms=p.emg_rms_drop_pct;
  const mdf=p.mdf_drop_pct;

  const risk=p.risk||{};
  const aLv=risk.angleRate||"low";
  const rLv=risk.rmsDrop||"low";
  const mLv=risk.mdfDrop||"low";
  const overall=risk.overall||"low";

  /* ANGLE */
  document.getElementById("angleRateVal").textContent=fmt(angle);
  const pill=document.getElementById("angleRateLevel");
  pill.className="pill "+levelClass(aLv);
  pill.textContent=aLv.toUpperCase();

  document.getElementById("angleRateMarker").style.left =
    clamp((angle/250)*100)+"%";

  /* EMG */
  if(emgReportLocked && emgSnapshot){
    renderEmg(emgSnapshot.rmsDrop,emgSnapshot.mdfDrop,emgSnapshot.rmsLevel,emgSnapshot.mdfLevel);
  } else {
    renderEmg(rms,mdf,rLv,mLv);
    emgSnapshot={rmsDrop:rms, mdfDrop:mdf, rmsLevel:rLv, mdfLevel:mLv};
  }

  /* COACHING */
  const c=getCoaching(overall,aLv,rLv,mLv);
  document.getElementById("guideText").textContent=c.guide;
  document.getElementById("coachStatusText").textContent=c.status;
  document.getElementById("coachTitle").textContent=c.title;
  document.getElementById("coachBody").textContent=c.body;

  const cp=document.getElementById("coachStatusPill");
  cp.style.background = overall==="high"? "#FFE1E1" :
                        overall==="med"? "#FFF3D6" : "#E7F4EF";
  cp.querySelector(".coach-status-pill-dot").style.background =
                        overall==="high"? "#E53935" :
                        overall==="med"? "#FFC107" : "#18A05D";
}

/* ===================== LOCK BUTTON ===================== */
document.getElementById("lockEmgReportBtn").addEventListener("click",()=>{
  const s=document.getElementById("lockStatusText");

  if(!emgSnapshot){
    s.textContent="ì•„ì§ EMG ë°ì´í„°ê°€ ì¶©ë¶„í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.\nì¡°ê¸ˆ ë” ì›€ì§ì¸ ë’¤ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.";
    return;
  }

  emgReportLocked=true;
  document.getElementById("lockEmgReportBtn").disabled=true;

  const {rmsDrop,mdfDrop}=emgSnapshot;
  s.textContent=getEmgSessionSummary(rmsDrop,mdfDrop);
});

</script>
</body>
</html>
