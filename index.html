<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>ì•ˆë‹¤ì¹˜ì¡° â€“ Wearable Real-time Dashboard</title>

  <!-- MQTT JS (Browser) -->
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

  <style>
    /* ============= Global ============= */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Pretendard", "Noto Sans KR",
        system-ui, sans-serif;
      background: radial-gradient(circle at 20% 10%, #E7F4EF, #F8FAF9 60%);
      color: #1f2a2c;
      padding: 24px;
    }

    .page {
      max-width: 1100px;
      margin: 0 auto;
    }

    /* ============= Header ============= */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 20px;
    }

    .brand-left {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .brand-top {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 4px;
    }

    .logo-wrap {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .andachi-logo {
      width: 48px;
      height: 48px;
      flex-shrink: 0;
      display: block;
    }

    .team-badge {
      display: inline-flex;
      align-items: center;
      padding: 4px 12px;
      border-radius: 999px;
      background: rgba(15, 76, 58, 0.10);
      border: 1px solid rgba(15, 76, 58, 0.24);
      color: #0F4C3A;
      font-size: 13px;
      font-weight: 600;
      letter-spacing: 0.3px;
    }

    .team-badge span {
      white-space: nowrap;
    }

    .title {
      font-size: 30px;
      font-weight: 800;
      color: #0F4C3A;
    }

    .subtitle {
      font-size: 13px;
      color: #5F6A67;
      margin-top: 2px;
    }

    .header-right {
      display: flex;
      align-items: flex-start;
      font-size: 12px;
      color: #7d8a85;
    }

    .last-update-label {
      margin-right: 4px;
      font-weight: 500;
    }

    /* ============= Layout ============= */
    .main-grid {
      display: grid;
      grid-template-columns: 2.1fr 1.2fr;
      gap: 16px;
    }

    @media (max-width: 900px) {
      .main-grid {
        grid-template-columns: 1fr;
      }
    }

    /* ============= Cards ============= */
    .card {
      background: #ffffff;
      border-radius: 18px;
      padding: 18px 20px;
      box-shadow: 0 10px 25px rgba(15, 76, 58, 0.07);
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .card-title {
      font-size: 18px;
      font-weight: 700;
      color: #1f2a2c;
    }

    .card-sub {
      font-size: 13px;
      color: #6b7a78;
      margin-bottom: 10px;
      line-height: 1.4;
    }

    /* ============= Pills ============= */
    .pill {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 4px 12px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }

    .pill-low {
      background: #E4F6EC;
      color: #0F6A3A;
    }

    .pill-med {
      background: #FFF3D6;
      color: #A76B11;
    }

    .pill-high {
      background: #FFE1E1;
      color: #B3261E;
    }

    /* í° pill (ì¢…í•© ìœ„í—˜ë„) */
    .pill-large {
      font-size: 16px;
      padding: 6px 18px;
    }

    .emg-pill {
      font-size: 11px;
      padding: 2px 8px;
      margin-left: 6px;
    }

    /* ============= Metric rows ============= */
    .metric-row {
      margin-top: 16px;
    }

    .metric-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }

    .metric-label {
      font-size: 14px;
      font-weight: 600;
      color: #1f2a2c;
    }

    .metric-unit {
      font-size: 12px;
      color: #8a9896;
      margin-left: 4px;
    }

    .metric-value {
      font-size: 13px;
      color: #4d5b59;
    }

    /* scale bar */
    .scale-bar {
      position: relative;
      height: 10px;
      border-radius: 999px;
      overflow: hidden;
      background: linear-gradient(
        to right,
        #C3E8D2 0%,
        #C3E8D2 33%,
        #FFE5AA 33%,
        #FFE5AA 66%,
        #FFC1C1 66%,
        #FFC1C1 100%
      );
      margin-bottom: 4px;
    }

    .scale-marker {
      position: absolute;
      top: -4px;
      width: 0;
      height: 18px;
      border-left: 3px solid #222;
    }

    .scale-caption {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      color: #8a9896;
    }

    .scale-caption span.dot {
      margin-right: 4px;
      font-size: 10px;
    }

    .scale-caption .safe   { color: #0F6A3A; }
    .scale-caption .warn   { color: #A76B11; }
    .scale-caption .danger { color: #B3261E; }

    .scale-caption .safe .dot   { color: #0F6A3A; }
    .scale-caption .warn .dot   { color: #FFC107; }
    .scale-caption .danger .dot { color: #E53935; }

    /* ============= Guide / Coaching ============= */
    .guide-title {
      font-size: 17px;
      font-weight: 700;
      margin-bottom: 6px;
      color: #1f2a2c;
    }

    .guide-text {
      font-size: 13px;
      color: #5F6A67;
      line-height: 1.5;
      margin-bottom: 14px;
    }

    .divider {
      height: 1px;
      background: #EEF3F2;
      margin: 10px 0 12px;
    }

    .coach-status-pill {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 999px;
      background: #E7F4EF;
      color: #0F4C3A;
      font-size: 12px;
      margin-bottom: 6px;
    }

    .coach-status-pill-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #18A05D;
      margin-right: 6px;
    }

    .coach-title {
      font-size: 15px;
      font-weight: 700;
      margin-bottom: 4px;
      color: #1f2a2c;
    }

    .coach-body {
      font-size: 13px;
      color: #5F6A67;
      line-height: 1.5;
      margin-bottom: 10px;
    }

    .coach-tips {
      font-size: 11px;
      color: #9aa7a4;
      line-height: 1.4;
    }

    .threshold-note {
      font-size: 11px;
      color: #9aa7a4;
      margin-top: 8px;
      line-height: 1.4;
      text-align: right;
    }

    /* small helper text */
    .hint-muted {
      font-size: 11px;
      color: #9AA7A4;
      margin-top: 4px;
    }

    /* EMG summary row */
    .emg-summary-row {
      margin-top: 22px;
      padding: 10px 12px;
      border-radius: 14px;
      background: #F7FBFA;
      border: 1px dashed #C7D9D4;
    }

    .emg-summary-title {
      font-size: 13px;
      font-weight: 600;
      color: #26413C;
      margin-bottom: 4px;
    }

    .emg-summary-text {
      font-size: 12px;
      color: #6B7A78;
      line-height: 1.5;
    }

    /* ì¤„ë°”ê¿ˆ(\n) í‘œì‹œìš© */
    .guide-text,
    .coach-body,
    .coach-tips {
      white-space: pre-line;
    }

    /* EMG ë¦¬í¬íŠ¸ ê³ ì • ë²„íŠ¼ */
    .lock-btn {
      margin-top: 8px;
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid #C7D9D4;
      background: #F7FBFA;
      font-size: 12px;
      cursor: pointer;
    }

    .lock-btn:disabled {
      opacity: 0.6;
      cursor: default;
    }
  </style>
</head>

<body>
  <div class="page">
    <!-- ================= Header ================= -->
    <header class="header">
      <div class="brand-left">
        <div class="brand-top">
          <!-- ANDACHI LOGO -->
          <div class="logo-wrap">
            <svg class="andachi-logo" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" aria-label="ANDACHI logo">
              <circle cx="32" cy="32" r="30" fill="#0F4C3A" />
              <path
                d="M32 14
                   L21 18
                   v12
                   c0 8.5 5 14.5 11 17.5
                   c6-3 11-9 11-17.5
                   V18
                   Z"
                fill="#F8FAF9"
              />
              <path
                d="M27 24
                   Q 32 24 34 28
                   Q 36 32 33 36
                   L 30 40"
                fill="none"
                stroke="#0F4C3A"
                stroke-width="2.8"
                stroke-linecap="round"
                stroke-linejoin="round"
              />
              <circle cx="33" cy="29.5" r="2.4" fill="#0F4C3A" />
              <path
                d="M38 19
                   q 5 -3 9 -1
                   q -2.5 5 -7.5 6
                   q -1.5 -2.5 -1.5 -5z"
                fill="#4E8A6D"
              />
            </svg>
          </div>

          <!-- Team badge -->
          <div class="team-badge">
            <span>ì•ˆë‹¤ì¹˜ì¡° ANDACHI</span>
          </div>
        </div>

        <div class="title">Wearable Real-time Dashboard</div>
        <div class="subtitle">IMU + EMG ê¸°ë°˜ ì‹¤ì‹œê°„ ë¬´ë¦ ë¶€ìƒ ìœ„í—˜ ëª¨ë‹ˆí„°ë§</div>
      </div>

      <div class="header-right">
        <span class="last-update-label">Last update:</span>
        <span id="lastUpdated">-</span>
      </div>
    </header>

    <!-- ================= Main Grid ================= -->
    <div class="main-grid">
      <!-- ========= LEFT: Risk metrics ========= -->
      <div>
        <div class="card">
          <div class="card-header">
            <div class="card-title">ì¢…í•© ìœ„í—˜ë„</div>
            <div id="overallPill" class="pill pill-large pill-low">LOW</div>
          </div>
          <div id="overallDesc" class="card-sub">
            í˜„ì¬ëŠ” ë¹„êµì  ì•ˆì •ì ì¸ ìƒíƒœì…ë‹ˆë‹¤. ì›€ì§ì„ íŒ¨í„´ì„ ì¥ì‹œê°„ ëª¨ë‹ˆí„°ë§í•˜ë©°,
            ìœ„í—˜ì´ ì˜¬ë¼ê°€ê¸° ì‹œì‘í•˜ëŠ” êµ¬ê°„ì„ ì°¾ëŠ” ë° í™œìš©í•´ ë³´ì„¸ìš”.
          </div>

          <!-- Knee angle rate -->
          <div class="metric-row">
            <div class="metric-top">
              <div>
                <span class="metric-label">ë¬´ë¦ ìƒëŒ€ ê°ì†ë„ í”¼í¬</span>
                <span class="metric-unit">(deg/s)</span>
              </div>
              <div class="metric-value">
                <span id="angleRateVal">-</span>
                <span> Â· </span>
                <span id="angleRateLevel" class="pill pill-low" style="font-size:11px; padding:2px 8px;">low</span>
              </div>
            </div>
            <div class="scale-bar">
              <div id="angleRateMarker" class="scale-marker"></div>
            </div>
            <div class="scale-caption">
              <span class="safe"><span class="dot">â—</span>ì•ˆì • (&lt; 100)</span>
              <span class="warn"><span class="dot">â—</span>ì£¼ì˜ (100â€“200)</span>
              <span class="danger"><span class="dot">â—</span>ìœ„í—˜ (&gt;= 200)</span>
            </div>
          </div>

          <!-- EMG session report (RMS / MDF) -->
          <div class="metric-row emg-summary-row">
            <div class="emg-summary-title">ì„¸ì…˜ EMG í”¼ë¡œ ë¦¬í¬íŠ¸</div>
            <div class="emg-summary-text">
              RMS ì¦ê°€ìœ¨: <span id="emgRmsReport">-</span>%
              <span id="emgRmsLevel" class="pill emg-pill pill-low" style="display:none;">LOW</span><br/>
              MDF ê°ì†Œìœ¨: <span id="emgMdfReport">-</span>%
              <span id="emgMdfLevel" class="pill emg-pill pill-low" style="display:none;">LOW</span>
            </div>
            <div class="hint-muted" style="white-space:pre-line;">
RMS ì¦ê°€ìœ¨: ê·¼ìœ¡ ì‚¬ìš©ëŸ‰ì´ ëŠ˜ì–´ë‚œ ì •ë„ì…ë‹ˆë‹¤. ê°’ì´ í´ìˆ˜ë¡ í›„ë°˜ë¶€ì— ë” ë§ì€ í˜ì„ ì“°ê³  ìˆë‹¤ëŠ” ëœ»ì´ì—ìš”.
MDF ê°ì†Œìœ¨: ê·¼ í”¼ë¡œê°€ ì–¼ë§ˆë‚˜ ìŒ“ì˜€ëŠ”ì§€ ë‚˜íƒ€ë‚´ëŠ” ì§€í‘œì˜ˆìš”. ê°’ì´ í´ìˆ˜ë¡ ì‰½ê²Œ ì§€ì¹˜ê³  ì§€ì§€ë ¥ì´ ë–¨ì–´ì ¸ìš”.
ì‹¤ì‹œê°„ ë°ì´í„°ëŠ” ê³„ì† ë³€í™”í•©ë‹ˆë‹¤.
ìš´ë™ì„ ë§ˆì¹œ ë’¤ ë²„íŠ¼ì„ ëˆŒëŸ¬ í•´ë‹¹ ì‹œì ì˜ ê°’ì„ ì„¸ì…˜ ë¦¬í¬íŠ¸ë¡œ ì €ì¥í•˜ì„¸ìš”.
            </div>
            <button id="lockEmgReportBtn" type="button" class="lock-btn">
              ìš´ë™ ì¢…ë£Œ Â· ì„¸ì…˜ ë¦¬í¬íŠ¸ ê³ ì •í•˜ê¸°
            </button>
            <div id="lockStatusText" class="hint-muted" style="margin-top:6px; white-space:pre-line;">
ì•„ì§ ì„¸ì…˜ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤. ìš´ë™ì„ ë§ˆì¹˜ë©´ ìœ„ ë²„íŠ¼ì„ ëˆŒëŸ¬ ë¦¬í¬íŠ¸ë¥¼ ê³ ì •í•˜ì„¸ìš”.
            </div>
          </div>
        </div>
      </div>

      <!-- ========= RIGHT: Guide & Coaching ========= -->
      <div>
        <div class="card" style="margin-bottom: 10px;">
          <div class="guide-title">ë¶€ìƒ ì˜ˆë°© ê°€ì´ë“œ</div>
          <div id="guideText" class="guide-text">
            ì„¼ì„œê°€ ì•ˆì •ì ìœ¼ë¡œ ìˆ˜ì§‘ë˜ë©´ ì´ ì˜ì—­ì— í˜„ì¬ ìœ„í—˜ ìš”ì¸ê³¼
            ì˜ˆë°© í–‰ë™ì´ í‘œì‹œë©ë‹ˆë‹¤.
          </div>
          <div class="divider"></div>

          <div class="guide-title" style="font-size: 16px;">AI ìì„¸ êµì • ì½”ë©˜íŠ¸</div>
          <div id="coachStatusPill" class="coach-status-pill">
            <span class="coach-status-pill-dot"></span>
            <span id="coachStatusText">ì•ˆì „ ìì„¸</span>
          </div>

          <div id="coachTitle" class="coach-title">ì¢‹ì€ ìì„¸ë¥¼ ìœ ì§€í•˜ê³  ìˆì–´ìš”</div>
          <div id="coachBody" class="coach-body">
            ì›€ì§ì„ì„ ì‹œì‘í•˜ë©´ ì„¼ì„œ ê¸°ë°˜ìœ¼ë¡œ ìì„¸ í”¼ë“œë°±ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.
          </div>

          <div id="coachTips" class="coach-tips">
            ê¸°ì¤€ê°’ ê°ì†ë„: &lt;100 low Â· 100â€“200 med Â· â‰¥200 high<br/>
            EMG í”¼ë¡œë„ëŠ” RMS ë³€í™”ìœ¨Â·MDF ê°ì†Œìœ¨ë¡œ ìš”ì•½ë˜ì–´ ì™¼ìª½ ë¦¬í¬íŠ¸ì— í‘œì‹œë©ë‹ˆë‹¤.
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ================= Scripts ================= -->
  <script>
    // ===== MQTT Settings =====
    const BROKER_URL = "wss://damoa.io:9002";
    const RISK_TOPIC = "ewha/2270056/risk";   // Colabì´ ë°œí–‰í•˜ëŠ” ìœ„í—˜ë„ í† í”½

    const clientId = "andachi-web-" + Math.random().toString(16).substring(2, 10);
    const client = mqtt.connect(BROKER_URL, { clientId });

    let emgReportLocked = false;
    let emgReportSnapshot = null;

    client.on("connect", () => {
      console.log("MQTT connected as", clientId);
      client.subscribe(RISK_TOPIC, (err) => {
        if (err) console.error("subscribe error:", err);
        else console.log("Subscribed to", RISK_TOPIC);
      });
    });

    client.on("error", (err) => {
      console.error("MQTT error:", err);
    });

    client.on("message", (topic, message) => {
      if (topic !== RISK_TOPIC) return;
      try {
        const payload = JSON.parse(message.toString());
        updateDashboard(payload);
      } catch (e) {
        console.error("JSON parse error:", e);
      }
    });

    // ===== Helper functions =====
    function fmtNumber(v, digits = 1) {
      if (v === null || v === undefined || !isFinite(v)) return "-";
      return v.toFixed(digits);
    }

    function levelToClass(level) {
      if (level === "high") return "pill-high";
      if (level === "med")  return "pill-med";
      if (level === "low")  return "pill-low";
      return "";
    }

    function clampPercent(v) {
      if (!isFinite(v)) return 0;
      return Math.max(0, Math.min(100, v));
    }

    // EMG ë¦¬í¬íŠ¸ë¥¼ ì‹¤ì œë¡œ ë Œë”ë§í•˜ëŠ” í•¨ìˆ˜
    function renderEmgReport(rmsDrop, mdfDrop, rmsLevel, mdfLevel) {
      const rmsSpan  = document.getElementById("emgRmsReport");
      const mdfSpan  = document.getElementById("emgMdfReport");
      const rmsPill  = document.getElementById("emgRmsLevel");
      const mdfPill  = document.getElementById("emgMdfLevel");

      // ê°’ í…ìŠ¤íŠ¸
      rmsSpan.textContent = (rmsDrop == null || !isFinite(rmsDrop)) ? "-" : fmtNumber(rmsDrop, 1);
      mdfSpan.textContent = (mdfDrop == null || !isFinite(mdfDrop)) ? "-" : fmtNumber(mdfDrop, 1);

      // RMS level pill
      if (rmsLevel === "unknown" || rmsDrop == null || !isFinite(rmsDrop)) {
        rmsPill.style.display = "none";
      } else {
        rmsPill.style.display = "inline-flex";
        rmsPill.className = "pill emg-pill " + levelToClass(rmsLevel);
        rmsPill.textContent = rmsLevel.toUpperCase();
      }

      // MDF level pill
      if (mdfLevel === "unknown" || mdfDrop == null || !isFinite(mdfDrop)) {
        mdfPill.style.display = "none";
      } else {
        mdfPill.style.display = "inline-flex";
        mdfPill.className = "pill emg-pill " + levelToClass(mdfLevel);
        mdfPill.textContent = mdfLevel.toUpperCase();
      }
    }

    // ===== ì„¸ì…˜ EMG ìš”ì•½ ë©˜íŠ¸ ìƒì„± (RMS Ã— MDF ì¡°í•©ë³„) =====
    function buildEmgSessionSummary(rmsPct, mdfPct, rmsLevel, mdfLevel) {
      const hasRms = rmsPct != null && isFinite(rmsPct);
      const hasMdf = mdfPct != null && isFinite(mdfPct);

      if (!hasRms && !hasMdf) {
        return "ì„¸ì…˜ ë¦¬í¬íŠ¸ê°€ ê³ ì •ë˜ì—ˆìŠµë‹ˆë‹¤.\n" +
               "EMG ë°ì´í„°ê°€ ì¶©ë¶„í•˜ì§€ ì•Šì•„ ì´ë²ˆ ì„¸ì…˜ì˜ í”¼ë¡œ ìš”ì•½ì„ ë§Œë“¤ê¸° ì–´ë µìŠµë‹ˆë‹¤.";
      }

      const lines = [];
      lines.push("ì„¸ì…˜ ë¦¬í¬íŠ¸ê°€ ê³ ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");

      if (hasRms) lines.push(`RMSëŠ” ì•½ ${rmsPct.toFixed(1)}% ì¦ê°€í–ˆìŠµë‹ˆë‹¤.`);
      if (hasMdf) lines.push(`MDFëŠ” ì•½ ${mdfPct.toFixed(1)}% ê°ì†Œí–ˆìŠµë‹ˆë‹¤.`);

      const r = (rmsLevel || "unknown").toLowerCase();
      const m = (mdfLevel || "unknown").toLowerCase();
      let advice = "";

      if (r === "low" && m === "low") {
        advice =
          "í›„ë°˜ë¶€ê¹Œì§€ í˜ ì‚¬ìš© ë³€í™”ê°€ í¬ì§€ ì•Šê³  í”¼ë¡œ ëˆ„ì ë„ ì ì€ í¸ì´ì—ìš”. " +
          "ì§€ê¸ˆì²˜ëŸ¼ ìì—°ìŠ¤ëŸ¬ìš´ í˜ì´ìŠ¤ë¥¼ ìœ ì§€í•˜ë©´ì„œ ê°€ë²¼ìš´ ì •ì  ìŠ¤íŠ¸ë ˆì¹­ ì •ë„ë§Œ í•´ì£¼ë©´ ì¶©ë¶„í•©ë‹ˆë‹¤.";
      } else if (r === "low" && m === "med") {
        advice =
          "ê·¼ ì‚¬ìš©ëŸ‰ì€ ì•ˆì •ì ì´ì§€ë§Œ í”¼ë¡œê°€ ì•½ê°„ ëˆ„ì ë˜ê³  ìˆì–´ìš”. " +
          "ê°•í•œ ìŠ¤íŠ¸ë ˆì¹­ë³´ë‹¤ëŠ” ì¢…ì•„ë¦¬Â·í–„ìŠ¤íŠ¸ë§ ìœ„ì£¼ì˜ ì§§ì€ ì¿¨ë‹¤ìš´ì„ ê¶Œì¥í•©ë‹ˆë‹¤.";
      } else if (r === "low" && m === "high") {
        advice =
          "ì‚¬ìš©ëŸ‰ ë³€í™”ëŠ” ê±°ì˜ ì—†ì§€ë§Œ í”¼ë¡œ ì§€í‘œê°€ í¬ê²Œ ë–¨ì–´ì¡Œì–´ìš”. " +
          "ê·¼ì§€êµ¬ë ¥ì´ ì†Œì§„ëœ ì‹ í˜¸ì¼ ìˆ˜ ìˆìœ¼ë‹ˆ ì˜¤ëŠ˜ì€ ì¶©ë¶„íˆ ì‰¬ê³  ê°•ë„ ë†’ì€ ìš´ë™ì€ í”¼í•´ì£¼ì„¸ìš”.";
      } else if (r === "med" && m === "low") {
        advice =
          "í›„ë°˜ìœ¼ë¡œ ê°ˆìˆ˜ë¡ í˜ì„ ì¡°ê¸ˆ ë” ì“°ê¸´ í–ˆì§€ë§Œ í”¼ë¡œ ëˆ„ì ì€ í¬ì§€ ì•Šì€ í¸ì´ì—ìš”. " +
          "ì²œì²œíˆ í˜¸í¡ì„ ì •ë¦¬í•˜ê³  ê´€ì ˆ ê°€ë™ì„± ìŠ¤íŠ¸ë ˆì¹­ì„ ë„£ì–´ì£¼ë©´ íšŒë³µì´ ë¹ ë¦…ë‹ˆë‹¤.";
      } else if (r === "med" && m === "med") {
        advice =
          "ê·¼ ì‚¬ìš©ëŸ‰ì´ ì¡°ê¸ˆ ì¦ê°€í–ˆê³  í”¼ë¡œë„ í•¨ê»˜ ìŒ“ì¸ ìƒíƒœì˜ˆìš”. " +
          "ì„¸ì…˜ ë§ˆë¬´ë¦¬ëŠ” ê°€ë²¼ìš´ ìŠ¤íŠ¸ë ˆì¹­ê³¼ 5ë¶„ ì •ë„ì˜ ëŠë¦° ë³´í–‰ ì¿¨ë‹¤ìš´ì„ ê¶Œì¥í•©ë‹ˆë‹¤.";
      } else if (r === "med" && m === "high") {
        advice =
          "í˜ ì‚¬ìš©ëŸ‰ì´ ëŠ˜ì–´ë‚œ ìƒíƒœì—ì„œ í”¼ë¡œë„ê°€ ë†’ê²Œ ëˆ„ì ë˜ì—ˆì–´ìš”. " +
          "ê·¼ìœ¡ ì§€ì§€ë ¥ì´ ë–¨ì–´ì§ˆ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì˜¤ëŠ˜ì€ ì¶©ë¶„íˆ ì‰¬ê³ , ë‹¤ìŒ ì„¸ì…˜ ê°•ë„ëŠ” ì‚´ì§ ë‚®ì¶”ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.";
      } else if (r === "high" && m === "low") {
        advice =
          "ê·¼ ì‚¬ìš©ëŸ‰ì´ í¬ê²Œ ì¦ê°€í–ˆì§€ë§Œ í”¼ë¡œëŠ” ì•„ì§ ì ì€ í¸ì´ì—ìš”. " +
          "ë™ì‘ íŒ¨í„´ì´ ê³¼í•˜ê²Œ í˜ì„ ì“°ëŠ” ë°©ì‹ì¼ ìˆ˜ ìˆìœ¼ë‹ˆ ì°©ì§€Â·ë³´í­Â·ìì„¸ë¥¼ ì ê²€í•´ ë³´ëŠ” ê²ƒì„ ì¶”ì²œí•©ë‹ˆë‹¤.";
      } else if (r === "high" && m === "med") {
        advice =
          "ì„¸ì…˜ í›„ë°˜ë¶€ì— í˜ì„ ë§ì´ ì“°ê³  í”¼ë¡œë„ í•¨ê»˜ ìŒ“ì¸ ìƒíƒœì˜ˆìš”. " +
          "ë¬´ë¦ ì£¼ë³€ ê·¼ìœ¡ì˜ ì•ˆì •ì„±ì´ ë–¨ì–´ì§ˆ ìˆ˜ ìˆìœ¼ë‹ˆ ì˜¤ëŠ˜ì€ ê°•ë„ ì¡°ì ˆê³¼ íšŒë³µì— íŠ¹íˆ ì‹ ê²½ ì¨ ì£¼ì„¸ìš”.";
      } else if (r === "high" && m === "high") {
        advice =
          "ê·¼ ì‚¬ìš©ëŸ‰ ì¦ê°€ì™€ í”¼ë¡œ ëˆ„ì ì´ ë™ì‹œì— í¬ê²Œ ë‚˜íƒ€ë‚¬ì–´ìš”. " +
          "ë¶€ìƒ ìœ„í—˜ì´ ë†’ì•„ì§€ëŠ” êµ¬ê°„ì´ë¯€ë¡œ ì¦‰ì‹œ íœ´ì‹í•˜ê³ , ë‹¤ìŒ í›ˆë ¨ ì „ ì¶©ë¶„í•œ íšŒë³µ ì‹œê°„ì„ í™•ë³´í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.";
      } else {
        advice =
          "ì´ë²ˆ ì„¸ì…˜ì˜ EMG íŒ¨í„´ì—ì„œ ì¼ë¶€ ê°’ì´ ë¶ˆì•ˆì •í•˜ê²Œ ì¸¡ì •ë˜ì—ˆìŠµë‹ˆë‹¤. " +
          "ê·¸ë˜ë„ ê°€ë²¼ìš´ ìŠ¤íŠ¸ë ˆì¹­ê³¼ ì¿¨ë‹¤ìš´ìœ¼ë¡œ ë§ˆë¬´ë¦¬í•´ ì£¼ì„¸ìš”.";
      }

      lines.push(advice);
      return lines.join("\n");
    }

    // AI coaching message logic
    function getCoaching(overall, angLevel, rmsLevel, mdfLevel) {
      let status = "";
      let title  = "";
      let body   = "";
      let guide  = "";

      if (overall === "low") {
        status = "ğŸŸ¢ LOW ìœ„í—˜ë„";
        title  = "í˜„ì¬ ìƒíƒœ ì–‘í˜¸í•©ë‹ˆë‹¤.";

        body =
          "ê°€ë³ê²Œ ë‹¬ë¦¬ê¸°ë¥¼ ì§„í–‰í•´ë„ ì¢‹ì€ ìƒíƒœì…ë‹ˆë‹¤.\n" +
          "ë‹¤ë§Œ ë¬´ë¦ ì£¼ë³€ ì§€ì§€ ê·¼ìœ¡(í™Â·ì½”ì–´)ì„ ê¾¸ì¤€íˆ ê°•í™”í•˜ê³ , " +
          "í›ˆë ¨ëŸ‰ì€ í‰ì†Œ ìˆ˜ì¤€ì—ì„œ í¬ê²Œ ë²—ì–´ë‚˜ì§€ ì•Šë„ë¡ ê´€ë¦¬í•´ ì£¼ì„¸ìš”.";

        guide =
          "âœ… ê¶Œì¥ í–‰ë™\n" +
          "â€¢ ë‹¬ë¦¬ê¸° ì „ ë™ì  ì›Œë°ì—… 5â€“10ë¶„ (ì˜ˆ: ë ˆê·¸ ìŠ¤ìœ™, í•˜ì´ ë‹ˆ)\n" +
          "â€¢ ë‹¬ë¦¬ê¸° í›„ í–„ìŠ¤íŠ¸ë§Â·ì¢…ì•„ë¦¬Â·ê³ ê´€ì ˆ ìŠ¤íŠ¸ë ˆì¹­ 20â€“30ì´ˆ ìœ ì§€\n" +
          "â€¢ ì£¼ê°„ í›ˆë ¨ ê±°ë¦¬Â·ê°•ë„ëŠ” í•œ ë²ˆì— +10% ì´ìƒ ê¸‰ê²©íˆ ì˜¬ë¦¬ì§€ ì•Šê¸°";

        return { status, title, body, guide };
      }

      if (overall === "med") {
        status = "ğŸŸ¡ MEDIUM ìœ„í—˜ë„";

        if (angLevel === "med" || angLevel === "high") {
          title = "í”¼ë¡œë‚˜ ì¶©ê²©ëŸ‰ì´ ì¦ê°€ëœ ìƒíƒœì…ë‹ˆë‹¤.";

          body =
            "ë¬´ë¦ì— ì „ë‹¬ë˜ëŠ” ìˆœê°„ ì¶©ê²©ì´ë‚˜ êµ½í˜ ì†ë„ê°€ í‰ì†Œë³´ë‹¤ ì»¤ì§„ ì‹ í˜¸ì…ë‹ˆë‹¤.\n" +
            "ì˜¤ëŠ˜ì€ ê±°ë¦¬ë¥¼ ì¤„ì´ê±°ë‚˜ í˜ì´ìŠ¤ë¥¼ ë‚®ì¶”ê³ , ë³´í­ì„ ì¡°ê¸ˆ ì¤„ì´ëŠ” ëŒ€ì‹ \n" +
            "ì¼€ì´ë˜ìŠ¤ë¥¼ ì•½ê°„ ë†’ì—¬ì„œ â€˜ê°€ë³ê²Œ, ìì£¼ ë”›ëŠ”â€™ íŒ¨í„´ì„ ë§Œë“¤ì–´ ë³´ì„¸ìš”.";
        } else if (rmsLevel === "med" || mdfLevel === "med") {
          title = "ê·¼ í”¼ë¡œê°€ ì„œì„œíˆ ìŒ“ì´ê³  ìˆì–´ìš”.";

          body =
            "EMG ì§€í‘œì—ì„œ í”¼ë¡œ ìˆ˜ì¤€ì´ ì¤‘ê°„ ì •ë„ë¡œ ì˜¬ë¼ê°€ê³  ìˆìŠµë‹ˆë‹¤.\n" +
            "ê·¼ìœ¡ì´ ì§€ì§€ë ¥ì„ ì¼ë¶€ ìƒê¸° ì‹œì‘í•œ ë‹¨ê³„ì´ë¯€ë¡œ, ë¬´ë¦¬í•œ í˜ì´ìŠ¤ ìœ ì§€ë³´ë‹¤ëŠ”\n" +
            "í›ˆë ¨ ê°•ë„ë¥¼ ì‚´ì§ ë‚®ì¶”ê³  íšŒë³µì— ì—¬ìœ ë¥¼ ì£¼ëŠ” í¸ì´ ì¢‹ìŠµë‹ˆë‹¤.";
        } else {
          title = "ë¶€í•˜ì™€ í”¼ë¡œê°€ ë‹¤ì†Œ ì˜¬ë¼ê°„ ìƒíƒœì…ë‹ˆë‹¤.";

          body =
            "ì¼ë¶€ ì§€í‘œì—ì„œ ìœ„í—˜ ì‹ í˜¸ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.\n" +
            "í›ˆë ¨ ê°•ë„ì™€ ê±°ë¦¬ë¥¼ ì•½ê°„ ì¤„ì´ê³ , ê¸°ìˆ (ì°©ì§€ íŒ¨í„´Â·ë³´í­Â·ì¼€ì´ë˜ìŠ¤)ì„ ì •ë¦¬í•˜ëŠ”\n" +
            "ë¦¬ì…‹ ë°ì´ë¡œ í™œìš©í•´ ë³´ì„¸ìš”.";
        }

        guide =
          "âœ… ê¶Œì¥ í–‰ë™\n" +
          "â€¢ ì˜¤ëŠ˜ì€ í‰ì†Œì˜ ì•½ 70â€“80% ìˆ˜ì¤€ ê±°ë¦¬/ê°•ë„ë¡œ ë‹¬ë¦¬ê¸°\n" +
          "â€¢ í™Â·ì¢…ì•„ë¦¬ ê·¼ë ¥ìš´ë™ 1â€“2ì„¸íŠ¸ ì¶”ê°€ (ì˜ˆ: í™ ì“°ëŸ¬ìŠ¤íŠ¸, ì¹´í”„ ë ˆì´ì¦ˆ)\n" +
          "â€¢ ë‹¬ë¦¬ê¸° ì‹œ ë³´í­ì„ ì¡°ê¸ˆ ì¤„ì´ê³  ì¼€ì´ë˜ìŠ¤ë¥¼ í‰ì†Œë³´ë‹¤ +5~10% ë†’ì—¬ë³´ê¸°";

        return { status, title, body, guide };
      }

      if (overall === "high") {
        status = "ğŸ”´ HIGH ìœ„í—˜ë„";

        if (angLevel === "high") {
          title = "ë¶€ìƒ ìœ„í—˜ì´ ë†’ìŠµë‹ˆë‹¤! ì˜¤ëŠ˜ì€ ê°•ë„ë¥¼ ì¦‰ì‹œ ë‚®ì¶°ì•¼ í•´ìš”.";

          body =
            "ê°ì†ë„ í”¼í¬ê°€ ë†’ê²Œ ì¸¡ì •ë˜ì–´, ì°©ì§€/ë°©í–¥ ì „í™˜ ì‹œ ë¬´ë¦ì— í° ë¶€í•˜ê°€ ê±¸ë¦¬ê³  ìˆìŠµë‹ˆë‹¤.\n" +
            "ì˜¤ëŠ˜ì€ ë‹¬ë¦¬ê¸°ë¥¼ ì¤‘ë‹¨í•˜ê³ , ìì „ê±°Â·ìˆ˜ì˜ ë“± ì €ì¶©ê²© í¬ë¡œìŠ¤ íŠ¸ë ˆì´ë‹ìœ¼ë¡œ ë°”ê¾¸ëŠ” ê²ƒì„ ê¶Œì¥í•©ë‹ˆë‹¤.\n" +
            "ì°©ì§€ íŒ¨í„´(ë¯¸ë“œí’‹/í¬ì–´í’‹), ë³´í­, ì¼€ì´ë˜ìŠ¤ë¥¼ ë‹¤ì‹œ ì ê²€í•˜ëŠ” â€˜ë¦¬ì…‹ ë°ì´â€™ë¡œ ì‚¬ìš©í•´ ì£¼ì„¸ìš”.";
        } else if (rmsLevel === "high" || mdfLevel === "high") {
          title = "ê·¼ í”¼ë¡œê°€ ë§ì´ ëˆ„ì ëœ ìƒíƒœì˜ˆìš”.";

          body =
            "EMG ê¸°ë°˜ í”¼ë¡œ ìˆ˜ì¤€ì´ ë†’ê²Œ ë‚˜íƒ€ë‚˜ ê·¼ìœ¡ì´ ì œ ì—­í• ì„ í•˜ê¸° ì–´ë ¤ìš´ êµ¬ê°„ì…ë‹ˆë‹¤.\n" +
            "ì´ ìƒíƒœì—ì„œëŠ” ë™ì‘ ì •í™•ë„ê°€ ë–¨ì–´ì§€ê³ , ê´€ì ˆì— ì§ì ‘ì ì¸ ë¶€ë‹´ì´ ì»¤ì ¸ ë¶€ìƒ ìœ„í—˜ì´ ë†’ìŠµë‹ˆë‹¤.\n" +
            "ì˜¤ëŠ˜ì€ ëŸ¬ë‹ ê°•ë„ë¥¼ ë‚®ì¶”ê±°ë‚˜ ì„¸ì…˜ì„ ì¢…ë£Œí•˜ê³  íšŒë³µì— ì§‘ì¤‘í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.";
        } else {
          title = "ì§€ê¸ˆì€ ë¶€ìƒ ìœ„í—˜ì´ ë†’ì€ êµ¬ê°„ì…ë‹ˆë‹¤.";

          body =
            "ì—¬ëŸ¬ ì§€í‘œë¥¼ ì¢…í•©í–ˆì„ ë•Œ ë¶€ìƒ ìœ„í—˜ì´ ë†’ì€ ìƒíƒœë¡œ í‰ê°€ë©ë‹ˆë‹¤.\n" +
            "ë‹¬ë¦¬ê¸° ê°•ë„ëŠ” ì¦‰ì‹œ ë‚®ì¶”ê³ , í•„ìš”í•˜ë‹¤ë©´ ì˜¤ëŠ˜ ëŸ¬ë‹ì„ ì‰¬ëŠ” ê²ƒì´ ì•ˆì „í•©ë‹ˆë‹¤.";
        }

        guide =
          "âœ… ê¶Œì¥ í–‰ë™\n" +
          "â€¢ ì˜¤ëŠ˜ì€ ë‹¬ë¦¬ê¸° ëŒ€ì‹  ê´€ì ˆ ë¶€ë‹´ì´ ì ì€ ìš´ë™(ì‹¤ë‚´ ìì „ê±°, ìˆ˜ì˜, ê°€ë²¼ìš´ ë³´í–‰ ë“±) ì„ íƒ\n" +
          "â€¢ ì°©ì§€ëŠ” ë¯¸ë“œí’‹/í¬ì–´í’‹ ìœ„ì£¼ë¡œ ì „í™˜í•˜ëŠ” ì—°ìŠµ (ë’¤ê¿ˆì¹˜ ê°•í•œ ì¶©ê²© í”¼í•˜ê¸°)\n" +
          "â€¢ ë³´í­ ì¤„ì´ê³  ì¼€ì´ë˜ìŠ¤ë¥¼ í‰ì†Œë³´ë‹¤ +10% ì´ìƒ ë†’ì´ëŠ” ëŸ¬ë‹ ë“œë¦´ì€ íšŒë³µ í›„ ë‹¨ê³„ì ìœ¼ë¡œ ì ìš©\n" +
          "â€¢ í™Â·í–„ìŠ¤íŠ¸ë§Â·ì¢…ì•„ë¦¬ ì§‘ì¤‘ ê·¼ë ¥ìš´ë™ + ì¶©ë¶„í•œ ìŠ¤íŠ¸ë ˆì¹­ìœ¼ë¡œ íšŒë³µì— ì§‘ì¤‘";

        return { status, title, body, guide };
      }

      status = "ë°ì´í„° ìˆ˜ì§‘ ëŒ€ê¸° ì¤‘";
      title  = "ì„¼ì„œ ìŠ¤íŠ¸ë¦¬ë°ì´ ì•ˆì •í™”ë˜ë©´ ì½”ì¹­ì´ í‘œì‹œë©ë‹ˆë‹¤.";
      body   = "IMUÂ·EMG ë°ì´í„°ê°€ ì¶©ë¶„íˆ ìŒ“ì´ë©´ í˜„ì¬ ìœ„í—˜ë„ì™€ í•¨ê»˜ ëŸ¬ë‹ ê°€ì´ë“œê°€ ì œê³µë©ë‹ˆë‹¤.";
      guide  = "ì„¼ì„œë¥¼ ì°©ìš©í•œ ë’¤ 10~20ì´ˆ ì •ë„ ê°€ë³ê²Œ ì›€ì§ì´ë©´ì„œ ë°ì´í„° ìˆ˜ì§‘ì„ ì‹œì‘í•´ ì£¼ì„¸ìš”.";

      return { status, title, body, guide };
    }

    // ===== ë²„íŠ¼ ì´ˆê¸°í™” =====
    (function initLockButton() {
      const lockBtn = document.getElementById("lockEmgReportBtn");
      const lockStatus = document.getElementById("lockStatusText");
      if (!lockBtn) return;

      lockBtn.addEventListener("click", () => {
        if (!emgReportSnapshot) {
          if (lockStatus) {
            lockStatus.textContent =
"ì•„ì§ EMG ë°ì´í„°ê°€ ì¶©ë¶„í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ëª‡ ì´ˆ ë” ì›€ì§ì¸ ë’¤ ë‹¤ì‹œ ëˆŒëŸ¬ì£¼ì„¸ìš”.";
          }
          return;
        }

        emgReportLocked = true;
        lockBtn.disabled = true;

        if (lockStatus) {
          const rmsPct  = emgReportSnapshot.rmsDrop;
          const mdfPct  = emgReportSnapshot.mdfDrop;
          const rmsLvl  = emgReportSnapshot.rmsLevel;
          const mdfLvl  = emgReportSnapshot.mdfLevel;

          const summary = buildEmgSessionSummary(rmsPct, mdfPct, rmsLvl, mdfLvl);
          lockStatus.textContent = summary;
        }
      });
    })();

    // ===== Main update =====
    function updateDashboard(payload) {
      console.log("risk payload:", payload);

      const ts = payload.ts || Date.now();
      const date = new Date(ts);
      const hh = String(date.getHours()).padStart(2, "0");
      const mm = String(date.getMinutes()).padStart(2, "0");
      const ss = String(date.getSeconds()).padStart(2, "0");
      document.getElementById("lastUpdated").textContent = `${hh}:${mm}:${ss}`;

      const angleRate = payload.angleRate_peak_deg_s;
      const rmsDrop   = payload.emg_rms_drop_pct;
      const mdfDrop   = payload.mdf_drop_pct;
      const risk      = payload.risk || {};

      const angleLevel = risk.angleRate || "unknown";
      const rmsLevel   = risk.rmsDrop   || "unknown";
      const mdfLevel   = risk.mdfDrop   || "unknown";

      // overall pill
      const overall = risk.overall || "low";
      const overallPill = document.getElementById("overallPill");
      overallPill.classList.remove("pill-low", "pill-med", "pill-high");
      overallPill.classList.add(levelToClass(overall));
      overallPill.textContent = overall.toUpperCase();

      // overall description
      function overallDescText(overallLvl) {
        if (overallLvl === "high") {
          return "í˜„ì¬ ì„¼ì„œ ê¸°ì¤€ìœ¼ë¡œ ë¶€ìƒ ìœ„í—˜ë„ê°€ ë†’ì€ ìƒíƒœì…ë‹ˆë‹¤. ê°•ë„ë¥¼ ì¦‰ì‹œ ì¤„ì´ê±°ë‚˜ ìš´ë™ì„ ì¤‘ë‹¨í•˜ê³ , ìì„¸ì™€ í”¼ë¡œë„ë¥¼ í•¨ê»˜ ì ê²€í•´ ì£¼ì„¸ìš”.";
        }
        if (overallLvl === "med") {
          return "ì¼ë¶€ ì§€í‘œì—ì„œ ìœ„í—˜ ì‹ í˜¸ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ë™ì‘ ì†ë„Â·ì°©ì§€ íŒ¨í„´Â·ê·¼ í”¼ë¡œ ì¤‘ ì–´ëŠ ë¶€ë¶„ì´ ë¬¸ì œì¸ì§€ ì˜¤ë¥¸ìª½ ê°€ì´ë“œë¥¼ ì°¸ê³ í•˜ì—¬ ì¡°ì •í•´ ë³´ì„¸ìš”.";
        }
        return "í˜„ì¬ëŠ” ë¹„êµì  ì•ˆì •ì ì¸ ìƒíƒœì…ë‹ˆë‹¤. ì›€ì§ì„ íŒ¨í„´ì„ ì¥ì‹œê°„ ëª¨ë‹ˆí„°ë§í•˜ë©°, ìœ„í—˜ì´ ì˜¬ë¼ê°€ê¸° ì‹œì‘í•˜ëŠ” êµ¬ê°„ì„ ì°¾ëŠ” ë° í™œìš©í•´ ë³´ì„¸ìš”.";
      }
      document.getElementById("overallDesc").textContent = overallDescText(overall);

      // ---- angle rate
      document.getElementById("angleRateVal").textContent =
        fmtNumber(angleRate, 1);
      const anglePill = document.getElementById("angleRateLevel");
      anglePill.classList.remove("pill-low", "pill-med", "pill-high");
      if (angleLevel !== "unknown") anglePill.classList.add(levelToClass(angleLevel));
      anglePill.textContent = angleLevel;

      const angleMax = 250;
      let anglePercent = 0;
      if (isFinite(angleRate)) anglePercent = clampPercent((angleRate / angleMax) * 100);
      document.getElementById("angleRateMarker").style.left = anglePercent + "%";

      // ---- EMG report (RMS / MDF) - ì„¸ì…˜ ë¦¬í¬íŠ¸ ê³ ì • ë¡œì§
      if (emgReportLocked && emgReportSnapshot) {
        renderEmgReport(
          emgReportSnapshot.rmsDrop,
          emgReportSnapshot.mdfDrop,
          emgReportSnapshot.rmsLevel,
          emgReportSnapshot.mdfLevel
        );
      } else {
        renderEmgReport(rmsDrop, mdfDrop, rmsLevel, mdfLevel);
        emgReportSnapshot = { rmsDrop, mdfDrop, rmsLevel, mdfLevel };
      }

      // ---- Guide & Coaching
      const coach = getCoaching(overall, angleLevel, rmsLevel, mdfLevel);
      document.getElementById("guideText").textContent       = coach.guide;
      document.getElementById("coachStatusText").textContent = coach.status;
      document.getElementById("coachTitle").textContent      = coach.title;
      document.getElementById("coachBody").textContent       = coach.body;

      const coachPill = document.getElementById("coachStatusPill");
      coachPill.style.background = (overall === "high")
        ? "#FFE1E1"
        : (overall === "med")
          ? "#FFF3D6"
          : "#E7F4EF";
      const dot = coachPill.querySelector(".coach-status-pill-dot");
      dot.style.background = (overall === "high")
        ? "#E53935"
        : (overall === "med")
          ? "#FFC107"
          : "#18A05D";
    }
  </script>
</body>
</html>
