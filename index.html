<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>안다치조 실시간 대시보드</title>

<!-- MQTT -->
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    body {
        margin: 0;
        padding: 0;
        font-family: Pretendard, sans-serif;
        background: #f5f6f7;
    }
    header {
        background: #0b3d2e;
        color: white;
        padding: 16px 22px;
        font-size: 24px;
        font-weight: 700;
    }
    .container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        padding: 20px;
        gap: 20px;
    }
    .card {
        background: white;
        padding: 18px;
        border-radius: 12px;
        box-shadow: 0 3px 6px rgba(0,0,0,0.08);
    }
    .card-title {
        font-size: 18px;
        font-weight: 700;
        margin-bottom: 10px;
        color: #0b3d2e;
    }
    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 6px;
    }
    th, td {
        border-bottom: 1px solid #eee;
        padding: 6px;
        font-size: 14px;
    }
    th {
        background: #eef3ef;
    }
    .pill {
        padding: 4px 12px;
        border-radius: 20px;
        font-weight: 600;
        color: white;
    }
    .low { background: #2ecc71; }
    .med { background: #f1c40f; color: black; }
    .high { background: #e74c3c; }

    #stickCanvas {
        width: 100%;
        height: 260px;
        background: #fafafa;
        border-radius: 10px;
    }
</style>

</head>
<body>

<header>안다치조 실시간 부상예방 대시보드</header>

<div class="container">

    <!-- ⭐ 새로 추가된 Stick Figure 카드 -->
    <div class="card">
        <div class="card-title">실시간 자세 (Stick Figure)</div>
        <canvas id="stickCanvas"></canvas>
    </div>

    <!-- 기존 구성 유지: 전체 위험도 카드 -->
    <div class="card">
        <div class="card-title">
            전체 위험도 <span id="overall-pill" class="pill low">low</span>
        </div>
        <div style="height:20px; background:#e6efe8; border-radius:10px; margin-top:10px; overflow:hidden;">
            <div id="risk-progress" style="
                height:100%; width:25%; 
                background:linear-gradient(90deg,#2ecc71,#f1c40f,#e74c3c);
                transition:0.5s;">
            </div>
        </div>
    </div>

    <!-- 그래프 3개 (기존 그대로) -->
    <div class="card"><div class="card-title">각속도 변화</div><canvas id="angleChart"></canvas></div>
    <div class="card"><div class="card-title">EMG RMS Drop</div><canvas id="rmsChart"></canvas></div>
    <div class="card"><div class="card-title">EMG MDF Drop</div><canvas id="mdfChart"></canvas></div>

    <!-- 위험도 테이블 (기존) -->
    <div class="card">
        <div class="card-title">세부 위험도</div>
        <table>
            <tr><th>지표</th><th>값</th><th>위험도</th></tr>
            <tr><td>각속도 peak</td><td id="val-angle">-</td><td id="risk-angle">-</td></tr>
            <tr><td>RMS drop</td><td id="val-rms">-</td><td id="risk-rms">-</td></tr>
            <tr><td>MDF drop</td><td id="val-mdf">-</td><td id="risk-mdf">-</td></tr>
            <tr><td>Local(IMU2)</td><td id="val-local">-</td><td id="risk-local">-</td></tr>
        </table>
    </div>

</div>

<script>
// ==================== MQTT 연결 ====================
const client = mqtt.connect("wss://damoa.io:9002");
client.on("connect", () => {
    console.log("MQTT connected!");
    client.subscribe("ewha/2270056/risk");
});

// ==================== 그래프 준비 (기존) ====================
function createChart(ctx) {
    return new Chart(ctx, {
        type:"line",
        data:{ labels:[], datasets:[{
            data:[], borderColor:"#0b3d2e", borderWidth:2, tension:0.2
        }]},
        options:{ animation:false, scales:{ x:{display:false}, y:{beginAtZero:true} } }
    });
}

const angleChart = createChart(document.getElementById("angleChart"));
const rmsChart   = createChart(document.getElementById("rmsChart"));
const mdfChart   = createChart(document.getElementById("mdfChart"));

// ==================== ⭐ Stick Figure 함수 추가 ====================
const sc = document.getElementById("stickCanvas");
const ctx = sc.getContext("2d");

function drawStick(angle){
    ctx.clearRect(0,0,sc.width,sc.height);

    const cx = sc.width/2;
    const cy = 70;

    const L1 = 80, L2 = 80;

    const rad = angle * Math.PI/180;

    const hx = cx + L1 * Math.sin(rad);
    const hy = cy + L1 * Math.cos(rad);

    const fx = hx + L2 * Math.sin(rad);
    const fy = hy + L2 * Math.cos(rad);

    ctx.lineWidth = 6;
    ctx.strokeStyle = "#0b3d2e";

    ctx.beginPath();
    ctx.moveTo(cx, cy);
    ctx.lineTo(hx, hy);
    ctx.lineTo(fx, fy);
    ctx.stroke();
}

// ==================== 위험도 색 (기존) ====================
function pillHtml(level){
    const cls = (level==="high")?"high":(level==="med")?"med":"low";
    return `<span class="pill ${cls}">${level}</span>`;
}

// ==================== MQTT 데이터 수신 ====================
client.on("message", (topic, msg) => {
    const d = JSON.parse(msg.toString());

    // 그래프 업데이트 (기존)
    angleChart.data.labels.push("");
    rmsChart.data.labels.push("");
    mdfChart.data.labels.push("");

    angleChart.data.datasets[0].data.push(d.angleRate_peak_deg_s);
    rmsChart.data.datasets[0].data.push(d.emg_rms_drop_pct);
    mdfChart.data.datasets[0].data.push(d.mdf_drop_pct);

    angleChart.update();
    rmsChart.update();
    mdfChart.update();

    // ⭐ StickFigure 업데이트
    drawStick(d.angleRate_peak_deg_s / 3);

    // 위험도 테이블 업데이트
    document.getElementById("val-angle").innerText = d.angleRate_peak_deg_s.toFixed(1);
    document.getElementById("val-rms").innerText   = d.emg_rms_drop_pct.toFixed(1);
    document.getElementById("val-mdf").innerText   = d.mdf_drop_pct.toFixed(1);
    document.getElementById("val-local").innerText = d.risk_local.imu2_gyr;

    document.getElementById("risk-angle").innerHTML = pillHtml(d.risk.angleRate);
    document.getElementById("risk-rms").innerHTML   = pillHtml(d.risk.rmsDrop);
    document.getElementById("risk-mdf").innerHTML   = pillHtml(d.risk.mdfDrop);
    document.getElementById("risk-local").innerHTML = pillHtml(d.risk_local.imu2_gyr);

    // 전체 위험도 ProgressBar
    const bar = document.getElementById("risk-progress");
    const pill = document.getElementById("overall-pill");

    pill.className = `pill ${d.risk.overall}`;
    pill.innerText = d.risk.overall;

    bar.style.width = (d.risk.overall==="high")?"100%":
                      (d.risk.overall==="med") ?"60%":"25%";
});
</script>

</body>
</html>
