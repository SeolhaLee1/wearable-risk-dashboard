<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script>
  // damoa WSS 후보들: 필요없는 건 지워도 됨
  const CANDIDATE_WS = [
    "wss://damoa.io:8083/mqtt",
    "wss://damoa.io:8083/",
    "wss://damoa.io:9001/mqtt",
    "wss://damoa.io/mqtt"
  ];
  const TOPIC = "ewha/2270056/risk";

  const $ = (id)=>document.getElementById(id);
  function connectTry(idx=0){
    if(idx >= CANDIDATE_WS.length){
      $("status").textContent = "connection error (all candidates failed)";
      console.error("[MQTT] All WSS candidates failed.");
      console.warn("Check: 1) WSS port open  2) path(/mqtt)  3) valid TLS cert (not self-signed).");
      return;
    }
    const url = CANDIDATE_WS[idx];
    console.log("[MQTT] Trying", url);
    $("status").textContent = `connecting… (${url})`;

    const cli = mqtt.connect(url, {
      clean: true,
      connectTimeout: 8000,
      clientId: "webdash_"+Math.random().toString(16).slice(2),
      // damoa가 계정/비번 요구하면 아래 주석 해제
      // username: "YOUR_USER",
      // password: "YOUR_PASS",
      keepalive: 30,
      reconnectPeriod: 0   // 우리가 수동으로 다음 후보 시도
    });

    let bound = false;

    cli.on("connect", () => {
      bound = true;
      console.log("[MQTT] Connected:", url);
      $("status").textContent = "connected";
      cli.subscribe(TOPIC);
      // 메시지 처리: 기존 코드에 있던 on('message') 콜백 연결
      cli.on("message", (_, payload) => {
        try {
          const d = JSON.parse(payload.toString());
          window.__handleRiskMessage && window.__handleRiskMessage(d); // 아래에서 정의
        } catch(e){ console.error(e); }
      });
    });

    cli.on("error", (e) => {
      console.error(`[MQTT] Error on ${url}:`, e);
    });

    cli.on("close", () => {
      if(bound){ // 한 번 붙었다 끊긴 경우 → 브로커 단절
        $("status").textContent = "reconnecting…";
        // 원한다면 여기서 같은 url로 재연결 로직 추가 가능
      }else{
        console.warn("[MQTT] Failed candidate:", url);
        // 다음 후보로 시도
        connectTry(idx+1);
      }
    });
  }
  connectTry();
</script>
