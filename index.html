<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ì•ˆë‹¤ì¹˜ì¡° ì‹¤ì‹œê°„ ë¬´ë¦ ìœ„í—˜ë„ ëŒ€ì‹œë³´ë“œ</title>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

<style>
  body {
    font-family: 'Pretendard', sans-serif;
    background: #f6f8f7;
    margin: 0;
    padding: 0;
  }

  header {
    background: #0c513f;
    color: white;
    padding: 20px 40px;
    display: flex;
    align-items: center;
    gap: 20px;
  }

  header h1 {
    margin: 0;
    font-size: 28px;
    font-weight: 700;
  }

  .logo {
    font-size: 36px;
    font-weight: 900;
    color: #b7e4c7;
  }

  .container {
    max-width: 900px;
    margin: 20px auto;
    padding: 20px;
  }

  .card {
    background: white;
    border-radius: 14px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  }

  .title {
    font-size: 20px;
    font-weight: 700;
    margin-bottom: 12px;
    color: #0c513f;
  }

  .value {
    font-size: 28px;
    font-weight: 700;
    color: #0c513f;
  }

  .pill {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 14px;
    font-weight: 700;
    display: inline-block;
    margin-left: 10px;
  }

  .pill.low { background:#d1f7d1; color:#0c513f; }
  .pill.med { background:#ffeeb5; color:#8a6d00; }
  .pill.high { background:#ffb3b3; color:#7a0000; }

  .risk-bar {
    height: 18px;
    width: 100%;
    border-radius: 10px;
    background: #ddd;
    overflow: hidden;
    margin-top: 10px;
  }

  .risk-bar-fill {
    height: 100%;
    width: 0%;
    transition: width 0.4s ease;
    border-radius: 10px;
    background: #0c513f;
  }

  /* 3D ìŠ¤í‹± í”¼ê²¨ ìº”ë²„ìŠ¤ */
  canvas {
    background: #ffffff;
    border-radius: 12px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.15);
    margin-top: 10px;
  }

  /* ì½”ë©˜íŠ¸ */
  .comment {
    font-size: 17px;
    color: #333;
    font-weight: 500;
    margin-top: 10px;
  }
</style>
</head>

<body>

<header>
  <div class="logo">ğŸ¦µ ì•ˆë‹¤ì¹˜ì¡°</div>
  <h1>ì‹¤ì‹œê°„ ë¬´ë¦ ë¶€ìƒ ìœ„í—˜ë„ ëŒ€ì‹œë³´ë“œ</h1>
</header>

<div class="container">

  <!-- ì¢…í•© ìœ„í—˜ë„ ì¹´ë“œ -->
  <div class="card">
    <div class="title">ì¢…í•© ìœ„í—˜ë„</div>
    <div id="overall_value" class="value">-</div>
    <div id="overall_pill" class="pill low">-</div>
    <div class="risk-bar">
      <div id="risk_bar_fill" class="risk-bar-fill"></div>
    </div>
    <div id="comment" class="comment"></div>
  </div>

  <!-- ë¬´ë¦ ìƒëŒ€ê°ë„ + 3D Stick Figure -->
  <div class="card">
    <div class="title">ë¬´ë¦ ìƒëŒ€ê°ë„ (IMU Relative Angle)</div>
    <div id="knee_angle_value" class="value">-Â°</div>
    <canvas id="stickFigure" width="320" height="260"></canvas>
  </div>

  <!-- ì„¸ë¶€ ì§€í‘œ ì¹´ë“œ -->
  <div class="card">
    <div class="title">ì„¸ë¶€ ìœ„í—˜ë„ ìš”ì†Œ</div>
    <p>ê°ì†ë„: <span id="ang_val">-</span> <span id="ang_pill" class="pill low">-</span></p>
    <p>EMG RMS Drop: <span id="rms_val">-</span> <span id="rms_pill" class="pill low">-</span></p>
    <p>MDF Drop: <span id="mdf_val">-</span> <span id="mdf_pill" class="pill low">-</span></p>
  </div>

</div>

<script>
/* ================================
      MQTT ì—°ê²°
================================ */

const broker = "wss://damoa.io:9002";
const topic  = "ewha/2270056/risk";

const clientId = "dashboard_" + Math.random().toString(16).substr(2, 8);
const client = mqtt.connect(broker, { clientId });

client.on("connect", () => {
  console.log("MQTT Connected");
  client.subscribe(topic);
});

client.on("message", (topic, msg) => {
  const data = JSON.parse(msg.toString());
  updateDashboard(data);
});

/* ===============================
     UI ì—…ë°ì´íŠ¸ í•¨ìˆ˜
================================ */

function updateDashboard(d) {

  const risk = d.risk?.overall || "unknown";
  const ang  = d.angleRate_peak_deg_s;
  const rms  = d.emg_rms_drop_pct;
  const mdf  = d.mdf_drop_pct;
  const knee = d.knee_angle_deg;   // Colabì—ì„œ ë³´ë‚´ëŠ” ìƒëŒ€ ë¬´ë¦ê° (deg)

  // ì¢…í•© ìœ„í—˜ë„ ê°’ + pill
  document.getElementById("overall_value").innerText = risk.toUpperCase();
  const pill = document.getElementById("overall_pill");
  pill.className = "pill " + risk;
  pill.innerText = risk;

  // ìœ„í—˜ë„ bar (0~100%)
  const bar = document.getElementById("risk_bar_fill");
  const order = {low:10, med:50, high:100, unknown:0};
  bar.style.width = (order[risk] || 0) + "%";

  // ì½”ë©˜íŠ¸
  const c = document.getElementById("comment");
  c.innerHTML = getComment(risk, ang, rms, mdf);

  // ë¬´ë¦ ê°ë„ + 3D stick figure
  if (knee !== null && !isNaN(knee)) {
    document.getElementById("knee_angle_value").innerText = knee.toFixed(1) + "Â°";
    drawStickFigure3D(knee);
  }

  // ì„¸ë¶€ ìœ„í—˜ë„ ìˆ«ì & pill
  setDetail("ang", ang, d.risk?.angleRate);
  setDetail("rms", rms, d.risk?.rmsDrop);
  setDetail("mdf", mdf, d.risk?.mdfDrop);
}

function setDetail(prefix, value, riskLevel) {
  document.getElementById(prefix + "_val").innerText =
    (value !== null && !isNaN(value)) ? value.toFixed(1) : "-";
  const pill = document.getElementById(prefix + "_pill");
  pill.className = "pill " + (riskLevel || "low");
  pill.innerText = riskLevel || "-";
}

/* ===============================
    3D ëŠë‚Œ ìŠ¤í‹± í”¼ê²¨ ê·¸ë¦¬ê¸°
================================ */
function drawStickFigure3D(kneeDeg) {
  const canvas = document.getElementById("stickFigure");
  const ctx = canvas.getContext("2d");
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // ê¸°ì¤€ ì¢Œí‘œ/ê¸¸ì´
  const centerX = canvas.width / 2;
  const hipY = 80;
  const torsoLen = 60;
  const thighLen = 70;
  const shankLen = 70;

  // ëª¸í†µ/ë¨¸ë¦¬
  const headX = centerX;
  const headY = hipY - torsoLen;
  const hipX  = centerX;
  const hipY2 = hipY;

  // ë¬´ë¦ì€ í•­ìƒ ì•„ë˜ë¡œ
  const kneeY = hipY2 + thighLen;
  const rad = kneeDeg * Math.PI / 180;

  // ì•ë‹¤ë¦¬(ìš°ë¦¬ ìª½)
  const frontHip = { x: hipX + 8, y: hipY2 };  // ì‚´ì§ ì˜¤ë¥¸ìª½
  const frontKnee = { x: frontHip.x, y: hipY2 + thighLen };
  const frontAnkle = {
    x: frontKnee.x + shankLen * Math.sin(rad),
    y: frontKnee.y + shankLen * Math.cos(rad)
  };

  // ë’·ë‹¤ë¦¬(ë¨¼ ìª½) â€“ ì¡°ê¸ˆ ì§§ê³  ìƒ‰ ì—°í•˜ê²Œ
  const backHip = { x: hipX - 6, y: hipY2 + 4 };
  const backKnee = { x: backHip.x, y: backHip.y + (thighLen - 6) };
  const backAnkle = {
    x: backKnee.x + (shankLen - 10) * Math.sin(rad * 0.9),
    y: backKnee.y + (shankLen - 10) * Math.cos(rad * 0.9)
  };

  // ë°”ë‹¥ íƒ€ì› (ë°œ ì•„ë˜ ê·¸ë¦¼ì)
  ctx.fillStyle = "rgba(0,0,0,0.05)";
  ctx.beginPath();
  ctx.ellipse(centerX, hipY2 + thighLen + shankLen + 20, 80, 18, 0, 0, Math.PI*2);
  ctx.fill();

  // ëª¸í†µ
  ctx.lineWidth = 5;
  ctx.strokeStyle = "#0c513f";
  ctx.beginPath();
  ctx.moveTo(headX, headY);
  ctx.lineTo(hipX, hipY2);
  ctx.stroke();

  // ë¨¸ë¦¬
  ctx.fillStyle = "#0c513f";
  ctx.beginPath();
  ctx.arc(headX, headY-12, 10, 0, Math.PI*2);
  ctx.fill();

  // ë’·ë‹¤ë¦¬
  ctx.lineWidth = 4;
  ctx.strokeStyle = "rgba(12, 81, 63, 0.4)";
  ctx.beginPath();
  ctx.moveTo(backHip.x, backHip.y);
  ctx.lineTo(backKnee.x, backKnee.y);
  ctx.lineTo(backAnkle.x, backAnkle.y);
  ctx.stroke();

  // ì•ë‹¤ë¦¬
  ctx.lineWidth = 6;
  ctx.strokeStyle = "#0c513f";
  ctx.beginPath();
  ctx.moveTo(frontHip.x, frontHip.y);
  ctx.lineTo(frontKnee.x, frontKnee.y);
  ctx.lineTo(frontAnkle.x, frontAnkle.y);
  ctx.stroke();

  // ê´€ì ˆ(ì•ë‹¤ë¦¬) ë™ê·¸ë¼ë¯¸
  ctx.fillStyle = "#0c513f";
  ctx.beginPath(); ctx.arc(frontHip.x, frontHip.y, 6, 0, Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.arc(frontKnee.x, frontKnee.y, 6, 0, Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.arc(frontAnkle.x, frontAnkle.y, 6, 0, Math.PI*2); ctx.fill();
}

/* ===============================
     AI-like ì½”ë©˜íŠ¸ ìƒì„±
================================ */
function getComment(risk, angrate, rms, mdf) {
  if (risk === "high")
    return "âš ï¸ ë¬´ë¦ì´ ë§¤ìš° ë¶ˆì•ˆì •í•©ë‹ˆë‹¤. <b>ì†ë„ë¥¼ ì¤„ì´ê³ </b> ë™ì‘ì„ ì²œì²œíˆ ìˆ˜í–‰í•˜ì„¸ìš”.";
  if (risk === "med")
    return "ì£¼ì˜ê°€ í•„ìš”í•©ë‹ˆë‹¤. ìì„¸ í”ë“¤ë¦¼ì´ ìˆìœ¼ë‹ˆ <b>ë¬´ë¦ ì •ë ¬</b>ì„ ë‹¤ì‹œ ë§ì¶°ë³´ì„¸ìš”.";
  if (risk === "low")
    return "ì•„ì£¼ ì•ˆì •ì ì…ë‹ˆë‹¤! ğŸ˜Š <b>ì§€ê¸ˆ ìì„¸ ê·¸ëŒ€ë¡œ ìœ ì§€</b>í•´ ì£¼ì„¸ìš”.";
  return "ë°ì´í„° ìˆ˜ì‹  ëŒ€ê¸° ì¤‘â€¦";
}
</script>

</body>
</html>
