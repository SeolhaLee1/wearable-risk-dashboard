<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>안다치조 – Wearable Real-time Dashboard</title>

  <!-- MQTT JS (Browser) -->
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Pretendard", "Noto Sans KR",
        system-ui, sans-serif;
      background: radial-gradient(circle at 20% 10%, #E7F4EF, #F8FAF9 60%);
      color: #1f2a2c;
      padding: 24px;
    }

    .page {
      max-width: 1100px;
      margin: 0 auto;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 20px;
    }

    .brand-left {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .brand-top {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 4px;
    }

    .andachi-logo {
      width: 48px;
      height: 48px;
    }

    .team-badge {
      display: inline-flex;
      align-items: center;
      padding: 4px 12px;
      border-radius: 999px;
      background: rgba(15, 76, 58, 0.10);
      border: 1px solid rgba(15, 76, 58, 0.24);
      color: #0F4C3A;
      font-size: 13px;
      font-weight: 600;
    }

    .title {
      font-size: 30px;
      font-weight: 800;
      color: #0F4C3A;
    }

    .subtitle {
      font-size: 13px;
      color: #5F6A67;
      margin-top: 2px;
    }

    .main-grid {
      display: grid;
      grid-template-columns: 2.1fr 1.2fr;
      gap: 16px;
    }

    @media (max-width: 900px) {
      .main-grid {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: #ffffff;
      border-radius: 18px;
      padding: 18px 20px;
      box-shadow: 0 10px 25px rgba(15, 76, 58, 0.07);
    }

    .card-title {
      font-size: 18px;
      font-weight: 700;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 4px 12px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
    }

    .pill-low {
      background: #E4F6EC;
      color: #0F6A3A;
    }

    .pill-med {
      background: #FFF3D6;
      color: #A76B11;
    }

    .pill-high {
      background: #FFE1E1;
      color: #B3261E;
    }

    .emg-summary-row {
      margin-top: 22px;
      padding: 10px 12px;
      border-radius: 14px;
      background: #F7FBFA;
      border: 1px dashed #C7D9D4;
    }

    .lock-btn {
      margin-top: 8px;
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid #C7D9D4;
      background: #F7FBFA;
      font-size: 12px;
      cursor: pointer;
    }

    .lock-btn:disabled {
      opacity: 0.6;
      cursor: default;
    }
  </style>

</head>

<body>
  <div class="page">
    <header class="header">
      <div class="brand-left">
        <div class="brand-top">
          <svg class="andachi-logo" viewBox="0 0 64 64">
            <circle cx="32" cy="32" r="30" fill="#0F4C3A" />
          </svg>
          <div class="team-badge">안다치조 ANDACHI</div>
        </div>

        <div class="title">Wearable Real-time Dashboard</div>
        <div class="subtitle">IMU + EMG 기반 실시간 무릎 부상 위험 모니터링</div>
      </div>

      <div class="header-right">
        <span class="last-update-label">Last update:</span>
        <span id="lastUpdated">-</span>
      </div>
    </header>

    <!-- ================= Main Grid ================= -->
    <div class="main-grid">

      <!-- LEFT -->
      <div>
        <div class="card">
          <div class="card-header">
            <div class="card-title">종합 위험도</div>
            <div id="overallPill" class="pill pill-low">LOW</div>
          </div>

          <div id="overallDesc" class="card-sub">
            현재는 비교적 안정적인 상태입니다.
          </div>

          <!-- Angle -->
          <div class="metric-row" style="margin-top: 16px;">
            <div>
              <span style="font-weight:600;">무릎 상대 각속도 피크</span>
              <span style="font-size:12px;color:#666;">(deg/s)</span>
            </div>

            <div style="margin-top:4px;">
              <span id="angleRateVal">-</span>
              <span> · </span>
              <span id="angleRateLevel" class="pill pill-low" style="font-size:11px;">low</span>
            </div>
          </div>

          <!-- EMG summary -->
          <div class="metric-row emg-summary-row">
            <div class="emg-summary-title">세션 EMG 피로 리포트</div>
            <div class="emg-summary-text">
              RMS 증가율: <span id="emgRmsReport">-</span>%  
              <span id="emgRmsLevel" class="pill emg-pill pill-low" style="display:none;">LOW</span><br/>
              MDF 감소율: <span id="emgMdfReport">-</span>%  
              <span id="emgMdfLevel" class="pill emg-pill pill-low" style="display:none;">LOW</span>
            </div>

            <div class="hint-muted" style="font-size:11px;margin-top:6px;">
              RMS 증가율 → 근육 사용량 증가  
              MDF 감소율 → 근 피로 누적 정도  
            </div>
          </div>

          <!-- ===== 세션 리포트 박스 추가됨 ===== -->
          <div class="metric-row" style="margin-top:18px; padding:12px; border-radius:14px;
               background:#F7FBFA; border:1px dashed #C7D9D4;">
            
            <div class="emg-summary-title">세션 리포트 요약</div>
            <div id="sessionReportText" class="emg-summary-text" style="white-space:pre-line;">
              운동 종료 후 버튼을 눌러 세션 리포트를 생성하세요.
            </div>

            <button id="lockEmgReportBtn" class="lock-btn" style="margin-top:10px;">
              운동 종료 · 세션 리포트 생성하기
            </button>

            <div id="lockStatusText" class="hint-muted" style="margin-top:6px;">
              아직 세션 진행 중입니다.
            </div>
          </div>

        </div>
      </div>

      <!-- RIGHT -->
      <div>
        <div class="card">
          <div style="font-size:17px; font-weight:700;">부상 예방 가이드</div>

          <div id="guideText" style="font-size:13px; margin-top:6px; color:#5F6A67; white-space:pre-line;">
            센서가 안정적으로 수집되면 이 영역에 현재 위험 요인과 조정 방법이 표시됩니다.
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- ================= Scripts ================= -->
  <script>
    const BROKER_URL = "wss://damoa.io:9002";
    const RISK_TOPIC = "ewha/2270056/risk";

    const clientId = "andachi-web-" + Math.random().toString(16).substring(2,10);
    const client = mqtt.connect(BROKER_URL, { clientId });

    let emgReportLocked = false;
    let emgReportSnapshot = null;

    client.on("connect", () => {
      client.subscribe(RISK_TOPIC);
    });

    client.on("message", (topic, message) => {
      if (topic !== RISK_TOPIC) return;
      try {
        const payload = JSON.parse(message.toString());
        updateDashboard(payload);
      } catch (e) { }
    });

    document.addEventListener("DOMContentLoaded", () => {
      const lockBtn = document.getElementById("lockEmgReportBtn");
      const lockStatus = document.getElementById("lockStatusText");
      const reportText = document.getElementById("sessionReportText");

      lockBtn.addEventListener("click", () => {
        if (!emgReportSnapshot) {
          lockStatus.textContent = "EMG 데이터가 충분하지 않습니다. 조금 더 움직인 뒤 다시 눌러주세요.";
          return;
        }

        emgReportLocked = true;
        lockBtn.disabled = true;
        lockStatus.textContent = "세션 리포트가 고정되었습니다.";

        reportText.textContent = generateSessionReport(
          emgReportSnapshot.rmsDrop,
          emgReportSnapshot.mdfDrop
        );
      });
    });

    function generateSessionReport(R, M) {
      if (!isFinite(R) || !isFinite(M))
        return "EMG 데이터가 충분하지 않아 세션 리포트를 생성할 수 없습니다.";

      if (R < 10 && M < 10) {
        return `RMS 증가율 ${R.toFixed(1)}%, MDF 감소율 ${M.toFixed(1)}%
→ 근 부하/피로 누적이 크지 않은 안정적인 세션입니다.
가벼운 스트레칭과 수분 보충 정도면 충분합니다.`;
      }
      if (R >= 10 && M < 10) {
        return `RMS 증가율 ${R.toFixed(1)}%
→ 근육 사용량이 크게 늘어난 강한 세션이었습니다.
피로 누적은 적어, 스트레칭과 가벼운 쿨다운을 추천합니다.`;
      }
      if (R < 10 && M >= 10) {
        return `MDF 감소율 ${M.toFixed(1)}%
→ 장시간 운동으로 지구력 피로가 누적된 세션입니다.
오늘은 폼롤러와 가벼운 회복을 권장합니다.`;
      }

      return `RMS 증가율 ${R.toFixed(1)}%, MDF 감소율 ${M.toFixed(1)}%
→ 부하 증가와 피로 누적이 동시에 나타난 강도 높은 세션입니다.
충분한 스트레칭과 휴식을 권장합니다.`;
    }

    function levelToClass(level) {
      if (level === "high") return "pill-high";
      if (level === "med") return "pill-med";
      return "pill-low";
    }

    function fmtNumber(v, d=1) {
      if (!isFinite(v)) return "-";
      return v.toFixed(d);
    }

    function updateDashboard(payload) {

      const ts = payload.ts;
      const d = new Date(ts);
      document.getElementById("lastUpdated").textContent =
        `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}:${String(d.getSeconds()).padStart(2,'0')}`;

      const risk = payload.risk || {};
      const overall = risk.overall || "low";

      const overallPill = document.getElementById("overallPill");
      overallPill.className = "pill " + levelToClass(overall);
      overallPill.textContent = overall.toUpperCase();

      document.getElementById("overallDesc").textContent =
        overall === "high" ? "현재 위험도가 높습니다. 강도를 줄이거나 운동을 중단하세요."
      : overall === "med" ? "일부 지표에서 위험 신호가 나타났습니다. 자세와 페이스 조절이 필요합니다."
      : "현재는 비교적 안정적인 상태입니다.";

      const angle = payload.angleRate_peak_deg_s;
      const angleLevel = risk.angleRate;

      document.getElementById("angleRateVal").textContent = fmtNumber(angle);
      const angPill = document.getElementById("angleRateLevel");
      angPill.textContent = angleLevel;
      angPill.className = "pill " + levelToClass(angleLevel);

      const rmsDrop = payload.emg_rms_drop_pct;
      const mdfDrop = payload.mdf_drop_pct;

      const rmsSpan = document.getElementById("emgRmsReport");
      const mdfSpan = document.getElementById("emgMdfReport");

      if (!emgReportLocked) {
        rmsSpan.textContent = fmtNumber(rmsDrop);
        mdfSpan.textContent = fmtNumber(mdfDrop);

        emgReportSnapshot = {
          rmsDrop: rmsDrop,
          mdfDrop: mdfDrop
        };
      }
    }
  </script>

</body>
</html>
